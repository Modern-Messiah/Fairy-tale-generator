# üìö –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∫–∞–∑–æ–∫ - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**–ù–∞–∑–≤–∞–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–µ—Ç—Å–∫–∏—Ö —Å–∫–∞–∑–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò  
**–¢–∏–ø:** –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Python FastAPI + Yii2 + OpenAI GPT + MySQL + Docker  

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–µ—Ç—Å–∫–∏—Ö —Å–∫–∞–∑–æ–∫ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ OpenAI GPT-4o-mini. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π –∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫–∏, –∞–¥–∞–ø—Ç–∞—Ü–∏—é –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–∞–∑–æ–∫.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP/REST    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Yii2 Frontend ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ Python FastAPI  ‚îÇ
‚îÇ   (PHP 8.2)     ‚îÇ                ‚îÇ   (Python 3.10) ‚îÇ
‚îÇ                 ‚îÇ                ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π ‚îÇ                ‚îÇ ‚Ä¢ OpenAI GPT    ‚îÇ
‚îÇ   –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å      ‚îÇ                ‚îÇ ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è      ‚îÇ
‚îÇ ‚Ä¢ –í–∞–ª–∏–¥–∞—Ü–∏—è      ‚îÇ                ‚îÇ ‚Ä¢ Streaming      ‚îÇ
‚îÇ ‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö    ‚îÇ                ‚îÇ ‚Ä¢ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                   ‚îÇ
         ‚îÇ                                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ MySQL  ‚îÇ                         ‚îÇ OpenAI  ‚îÇ
    ‚îÇ –ë–∞–∑–∞   ‚îÇ                         ‚îÇ API     ‚îÇ
    ‚îÇ –¥–∞–Ω–Ω—ã—Ö ‚îÇ                         ‚îÇ GPT-4o  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí **Yii2 Frontend** (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã)
2. **Yii2** ‚Üí **Python API** (HTTP –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
3. **Python API** ‚Üí **OpenAI GPT** (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–∫–∏)
4. **OpenAI GPT** ‚Üí **Python API** (streaming –æ—Ç–≤–µ—Ç)
5. **Python API** ‚Üí **Yii2** (–ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ stream)
6. **Yii2** ‚Üí **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** (real-time –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
7. **Yii2** ‚Üí **MySQL** (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π —Å–∫–∞–∑–∫–∏)

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Fairy-tale-generator/
‚îú‚îÄ‚îÄ üìÅ python-story-api/          # Python FastAPI –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ main.py           # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ models.py         # Pydantic –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ services.py       # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ config.py         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ __init__.py       # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ requirements.txt       # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ Dockerfile            # Docker –æ–±—Ä–∞–∑ Python
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ .env.example          # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ Dockerfile            # Docker –æ–±—Ä–∞–∑ Python —Å–µ—Ä–≤–∏—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ requirements.txt       # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ README.md              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Python API
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ test_api.py           # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã Python API
‚îÇ
‚îú‚îÄ‚îÄ üìÅ yii2-app/                  # Yii2 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ modules/story/         # –ú–æ–¥—É–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ DefaultController.php  # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ Story.php              # ActiveRecord –º–æ–¥–µ–ª—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ StoryForm.php          # –§–æ—Ä–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ StoryApiService.php    # API —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ views/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ default/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ index.php          # –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ stream.php         # –°—Ç—Ä–∞–Ω–∏—Ü–∞ real-time –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å SSE
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ history.php        # –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–∑–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ view.php           # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∫–∞–∑–∫–∏ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ layouts/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ main.php           # Layout –º–æ–¥—É–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ migrations/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ m241206_000000_create_story_table.php    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–∫–∞–∑–æ–∫
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ m241207_000000_drop_updated_at_from_story.php # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ Module.php                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ config/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Yii2 –∏ –º–æ–¥—É–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ docker-compose.yml      # Docker –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ composer.json           # PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ Module.php               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è —Å–∫–∞–∑–æ–∫
‚îÇ
‚îî‚îÄ‚îÄ üìÑ README.md                   # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üêç Python FastAPI Backend

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∫–∞–∑–æ–∫ —á–µ—Ä–µ–∑ OpenAI GPT-4o-mini
- –í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- Streaming –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üìÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

#### `app/main.py` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
# üöÄ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å lifecycle management
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
    - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞–µ—Ç StoryGeneratorService –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    - –†–∞–±–æ—Ç–∞: yield –æ—Ç–¥–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
    - –û—á–∏—Å—Ç–∫–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
    """
    global story_service
    story_service = StoryGeneratorService()
    logger.info("‚úÖ Story Generator Service initialized")
    
    yield  # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
    if story_service:
        await story_service.cleanup()

# üéØ –û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫
@app.post("/generate_story")
async def generate_story(request: StoryRequest):
    """
    –ì–ª–∞–≤–Ω—ã–π API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫
    
    –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:
    1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç StoryRequest —Å –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    2. –°–æ–∑–¥–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä generate()
    3. –í—ã–∑—ã–≤–∞–µ—Ç story_service.generate_story_stream() —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ StreamingResponse
    5. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: StreamingResponse —Å media_type="text/plain"
    """
    async def generate():
        async for chunk in story_service.generate_story_stream(
            age=request.age,
            language=request.language,
            characters=request.characters,
        ):
            yield chunk  # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç—É
            await asyncio.sleep(0.01)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    
    return StreamingResponse(generate(), media_type="text/plain")

# üîç Health check —ç–Ω–¥–ø–æ–∏–Ω—Ç
@app.get("/health")
async def health_check():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ
    """
    return {"status": "healthy", "service": "story-generator"}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ **Lifecycle management** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ **StreamingResponse** - –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —á–∞—Å—Ç—è–º –¥–ª—è real-time UX
- ‚úÖ **CORS middleware** - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Yii2 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —á–µ—Ä–µ–∑ Pydantic –º–æ–¥–µ–ª–∏
- ‚úÖ **Health monitoring** - —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞

#### `app/models.py` - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
# üìã StoryRequest - –º–æ–¥–µ–ª—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
class StoryRequest(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫
    
    –ü–æ–ª—è:
    - age: –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞ (1-10 –ª–µ—Ç) —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    - language: —è–∑—ã–∫ (ru/kk) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é
    - characters: —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    """
    age: int = Field(..., gt=0, le=10, description="–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞ (1-10 –ª–µ—Ç)")
    language: str = Field(..., pattern="^(ru|kk)$", description="–Ø–∑—ã–∫: ru/kk")
    characters: List[str] = Field(..., min_length=1, max_length=10)
    
    @field_validator('characters')
    @classmethod
    def validate_characters(cls, v: List[str]) -> List[str]:
        """
        –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        2. –£–¥–∞–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–æ–±–µ–ª—ã
        3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—á–∏—â–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        
        –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç ValueError –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª
        """
        if not v or len(v) == 0:
            raise ValueError('–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂')
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        cleaned = [char.strip() for char in v if char.strip()]
        if len(cleaned) != len(set(cleaned)):
            raise ValueError('–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è')
        
        return cleaned

# üìä StoryResponse - –º–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
class StoryResponse(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ API
    """
    success: bool
    message: str
    data: Optional[Dict[str, Any]] = None
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Pydantic:**
- üîí **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- üìù **–ê–≤—Ç–æ–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è JSON Schema –¥–ª—è Swagger
- ‚ö° **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- üõ°Ô∏è **Type safety** - —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- üìã **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** - –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏

#### `app/services.py` - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
class StoryGeneratorService:
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫ —á–µ—Ä–µ–∑ OpenAI API
    
    –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ OpenAI
    - –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
    - –ü–æ—Ç–æ–∫–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    """
    
    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞:
        - –°–æ–∑–¥–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π OpenAI –∫–ª–∏–µ–Ω—Ç
        - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        """
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
        self.model = settings.OPENAI_MODEL  # gpt-4o-mini
        self.logger = logging.getLogger(__name__)
    
    def _create_system_prompt(self, age: int, language: str) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –∏ —è–∑—ã–∫
        
        –î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞:
        - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å
        - –û–±—ä–µ–º 600-1200 —Å–ª–æ–≤
        - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≤—è–∑–∫–∞ ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Üí –∫—É–ª—å–º–∏–Ω–∞—Ü–∏—è ‚Üí —Ä–∞–∑–≤—è–∑–∫–∞
        - –î–æ–±—Ä—ã–π —Ñ–∏–Ω–∞–ª
        
        –î–ª—è –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞:
        - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö –∏–º–µ–Ω
        - –ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        """
        if language == "ru":
            return f"""
            –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å-—Å–∫–∞–∑–æ—á–Ω–∏–∫.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ, –¥–æ–±—Ä—ã–µ —Å–∫–∞–∑–∫–∏ –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.
            
            –í–æ–∑—Ä–∞—Å—Ç —á–∏—Ç–∞—Ç–µ–ª—è: {age} –ª–µ—Ç
            –û–±—ä—ë–º: 600‚Äì1200 —Å–ª–æ–≤
            –°—Ç–∏–ª—å: –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π —Ä–µ–±—ë–Ω–∫—É {age} –ª–µ—Ç
            –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≤—è–∑–∫–∞ ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Üí –∫—É–ª—å–º–∏–Ω–∞—Ü–∏—è ‚Üí —Ä–∞–∑–≤—è–∑–∫–∞
            –§–∏–Ω–∞–ª: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±—Ä—ã–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π
            """
        
        # –ö–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏–º–µ–Ω
        return f"""
        –°—ñ–∑ ‚Äî –∫”ô—Å—ñ–±–∏ –±–∞–ª–∞–ª–∞—Ä –∂–∞–∑—É—à—ã—Å—ã.
        –ú—ñ–Ω–¥–µ—Ç—ñ“£—ñ–∑ ‚Äî {age} –∂–∞—Å—Ç–∞“ì—ã –±–∞–ª–∞“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω “õ—ã–∑—ã“õ—Ç—ã –µ—Ä—Ç–µ–≥—ñ –ñ–ê–ó–£.
        
        –ï–ì–ï–† –∫–µ–π—ñ–ø–∫–µ—Ä–¥—ñ“£ –∞—Ç—ã –±–∞—Å“õ–∞ —Ç—ñ–ª–¥–µ –±–æ–ª—Å–∞, 
        –æ–ª–∞—Ä–¥—ã –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ “õ–∞–∑–∞“õ—à–∞ –ê–£–î–ê–†–´“¢–´–ó!
        """
    
    def _create_user_prompt(self, characters: List[str], language: str) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
        
        –§–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ GPT —Å —É–∫–∞–∑–∞–Ω–∏–µ–º:
        - –°–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        - –Ø–∑—ã–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        """
        chars_text = ", ".join(characters)
        
        if language == "ru":
            return f"–ù–∞–ø–∏—à–∏ —Å–∫–∞–∑–∫—É —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏: {chars_text}. –°–¥–µ–ª–∞–π –µ—ë –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∏ –ø–æ—É—á–∏—Ç–µ–ª—å–Ω–æ–π."
        else:
            return f"–ö–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä–º–µ–Ω –µ—Ä—Ç–µ–≥—ñ –∂–∞–∑: {chars_text}. –û–Ω—ã “õ—ã–∑—ã“õ—Ç—ã –∂”ô–Ω–µ —Ç”ô—Ä–±–∏–µ–ª—ñ–∫ –µ—Ç."
    
    async def generate_story_stream(self, age: int, language: str, characters: List[str]):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏ –≤ –ø–æ—Ç–æ–∫–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        
        –ü—Ä–æ—Ü–µ—Å—Å:
        1. –°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç—ã
        2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenAI GPT —Å stream=True
        3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ —á–∞—Å—Ç—è–º (—á–∞–Ω–∫–∞–º–∏)
        4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥—ã–π —á–∞–Ω–∫ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ yield
        5. –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - temperature=0.8: –±–∞–ª–∞–Ω—Å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏
        - max_tokens=2000: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–∫–∞–∑–∫–∏
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∞–Ω–∫–æ–≤ —Ç–µ–∫—Å—Ç–∞
        """
        try:
            self.logger.info(f"üìö Generating story: age={age}, lang={language}, chars={characters}")
            
            system_prompt = self._create_system_prompt(age, language)
            user_prompt = self._create_user_prompt(characters, language)
            
            # –ó–∞–ø—Ä–æ—Å –∫ OpenAI GPT —Å streaming
            stream = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt},
                ],
                stream=True,  # –í–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—É—é –ø–µ—Ä–µ–¥–∞—á—É
                temperature=0.8,
                max_tokens=2000,
            )
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–æ–≤ –∫–ª–∏–µ–Ω—Ç—É
            async for chunk in stream:
                if chunk.choices[0].delta.content:
                    yield chunk.choices[0].delta.content
                    
        except Exception as e:
            self.logger.error(f"‚ùå Error generating story: {str(e)}", exc_info=True)
            raise
    
    async def cleanup(self):
        """
        –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞
        –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å
        """
        if self.client:
            await self.client.close()
        self.logger.info("üßπ StoryGeneratorService cleaned up")
```

**–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- üß† **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã** - —É—á–∏—Ç—ã–≤–∞—é—Ç –≤–æ–∑—Ä–∞—Å—Ç –∏ —è–∑—ã–∫
- üåç **–î–≤—É—è–∑—ã—á–Ω–æ—Å—Ç—å** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ
- üîÑ **Streaming** - —Ç–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- üé≠ **–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –∏–º–µ–Ω
- üìä **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω—ã–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- üõ°Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- üßπ **Resource management** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

#### `app/config.py` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
class Settings(BaseSettings):
    """
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    
    –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ .env —Ñ–∞–π–ª–∞
    - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏–π
    - –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π (dev/prod)
    """
    
    # OpenAI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    OPENAI_API_KEY: str = Field(..., description="API –∫–ª—é—á OpenAI (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)")
    OPENAI_MODEL: str = Field(default="gpt-4o-mini", description="–ú–æ–¥–µ–ª—å OpenAI")
    OPENAI_BASE_URL: str = Field(default="https://api.openai.com/v1", description="Base URL OpenAI API")
    
    # API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    API_HOST: str = Field(default="0.0.0.0", description="–•–æ—Å—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ API")
    API_PORT: int = Field(default=8000, description="–ü–æ—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ API")
    API_WORKERS: int = Field(default=1, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ worker –ø—Ä–æ—Ü–µ—Å—Å–æ–≤")
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    LOG_LEVEL: str = Field(default="INFO", description="–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è")
    LOG_FORMAT: str = Field(default="%(asctime)s - %(name)s - %(levelname)s - %(message)s")
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    CORS_ORIGINS: List[str] = Field(default=["http://localhost:8000"], description="–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ CORS origins")
    RATE_LIMIT: int = Field(default=100, description="–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É")
    
    # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    MAX_CONTENT_LENGTH: int = Field(default=100000, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–±–∞–π—Ç)")
    STREAM_TIMEOUT: int = Field(default=300, description="–¢–∞–π–º–∞—É—Ç streaming (—Å–µ–∫)")
    
    model_config = SettingsConfigDict(
        env_file=".env",           # –ß—Ç–µ–Ω–∏–µ –∏–∑ .env —Ñ–∞–π–ª–∞
        env_file_encoding="utf-8",
        case_sensitive=True,
        extra="ignore",            # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    )
    
    def validate_config(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        
        –ü—Ä–æ–≤–µ—Ä–∫–∏:
        - –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        - –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π
        - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: True –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞
        """
        if not self.OPENAI_API_KEY:
            return False
        
        if not (1 <= self.API_PORT <= 65535):
            return False
            
        return True
    
    def get_cors_config(self) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é CORS –¥–ª—è FastAPI
        
        Returns:
            dict: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã CORS middleware
        """
        return {
            "allow_origins": self.CORS_ORIGINS,
            "allow_credentials": True,
            "allow_methods": ["GET", "POST"],
            "allow_headers": ["*"],
        }
    
    def get_logging_config(self) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        
        Returns:
            dict: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ logging
        """
        return {
            "level": self.LOG_LEVEL,
            "format": self.LOG_FORMAT,
            "handlers": [
                {
                    "class": "logging.StreamHandler",
                    "formatter": "default",
                }
            ],
            "formatters": {
                "default": {
                    "format": self.LOG_FORMAT,
                }
            }
        }

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
settings = Settings()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
- üîß **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- üõ°Ô∏è **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π
- üåç **–ú—É–ª—å—Ç–∏–æ–∫—Ä—É–∂–µ–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ dev/staging/prod
- üìù **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏

---

## üêò Yii2 Frontend

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
- –í–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Python API
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–∞–∑–æ–∫
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Server-Sent Events

### üìÅ –ú–æ–¥—É–ª—å Story (`modules/story/`)

#### `controllers/DefaultController.php` - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php
class DefaultController extends Controller
{
    private $_apiService;  // –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Python API
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     * - –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ StoryApiService
     * - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Python API
     */
    public function init()
    {
        parent::init();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API —Å–µ—Ä–≤–∏—Å–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ –º–æ–¥—É–ª—è
        $this->_apiService = new StoryApiService([
            'apiUrl' => $this->module->pythonApiUrl,
            'timeout' => $this->module->pythonApiTimeout,
        ]);
    }
    
    /**
     * –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏
     * 
     * –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:
     * 1. –°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç—É—é –º–æ–¥–µ–ª—å StoryForm
     * 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º—ã
     * 3. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
     * 4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏—é
     * 5. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     * 6. –ü—Ä–∏ GET –∑–∞–ø—Ä–æ—Å–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É
     * 
     * @return string|Response
     */
    public function actionIndex()
    {
        $model = new StoryForm();
        
        if ($model->load(Yii::$app->request->post()) && $model->validate()) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏—é –¥–ª—è streaming
            Yii::$app->session->set("storyFormData", $model->toApiData());
            return $this->redirect(["stream"]);
        }
        
        return $this->render("index", ["model" => $model]);
    }
    
    /**
     * –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Å—Å–∏–∏
     * - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å JavaScript –¥–ª—è SSE
     * - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö
     * 
     * @return string|Response
     */
    public function actionStream()
    {
        $formData = Yii::$app->session->get("storyFormData");
        
        if (!$formData) {
            Yii::$app->session->setFlash("error", "–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É");
            return $this->redirect(["index"]);
        }
        
        return $this->render("stream", [
            "formData" => $formData
        ]);
    }
    
    /**
     * API endpoint –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ø—Ä–æ–∫—Å–∏ –∫ Python API)
     * 
     * –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è real-time —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
     * 
     * –ü—Ä–æ—Ü–µ—Å—Å:
     * 1. –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞
     * 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è Server-Sent Events
     * 3. –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏–∑ —Å–µ—Å—Å–∏–∏
     * 4. –í—ã–∑—ã–≤–∞–µ—Ç Python API —á–µ—Ä–µ–∑ StoryApiService
     * 5. –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç streaming –æ—Ç–≤–µ—Ç –≤ SSE —Ñ–æ—Ä–º–∞—Ç–µ
     * 6. –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
     * 7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∫–∞–∑–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
     * 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ID
     * 
     * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
     * - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ PHP
     * - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è SSE
     * - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å UTF-8 —á–∞–Ω–∫–∞–º–∏
     * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     */
    public function actionGenerate()
    {
        // üî• –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è SSE
        while (ob_get_level()) {
            ob_end_clean();
        }
        
        Yii::$app->response->format = Response::FORMAT_RAW;
        $formData = Yii::$app->session->get("storyFormData");
        
        if (!$formData) {
            echo "data: " . json_encode(["error" => "No form data found"]) . "\n\n";
            Yii::$app->end();
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è Server-Sent Events
        header("Content-Type: text/event-stream");
        header("Cache-Control: no-cache");
        header("Connection: keep-alive");
        header("X-Accel-Buffering: no"); // –û—Ç–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é nginx
        
        $fullContent = "";
        $error = null;
        
        try {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∫–∞–∑–∫—É —Å –ø–æ—Ç–æ–∫–æ–≤—ã–º –≤—ã–≤–æ–¥–æ–º
            $this->_apiService->generateStoryStream($formData, function ($chunk) use (&$fullContent) {
                $fullContent .= $chunk;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º chunk –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ SSE
                $sseData = json_encode(["chunk" => $chunk]);
                echo "data: {$sseData}\n\n";
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—É—Ñ–µ—Ä–∞
                if (function_exists("fastcgi_finish_request")) {
                    fastcgi_finish_request();
                } else {
                    flush();
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            $story = new Story();
            $story->age = $formData["age"];
            $story->language = $formData["language"];
            $story->setCharactersArray($formData["characters"]);
            $story->content = $fullContent;
            
            if ($story->save()) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ID
                $finalData = json_encode([
                    "done" => true,
                    "story_id" => $story->id,
                ]);
                echo "data: {$finalData}\n\n";
            } else {
                $error = "Failed to save story: " . implode(", ", $story->errors);
            }
            
        } catch (Exception $e) {
            $error = "Generation error: " . $e->getMessage();
        }
        
        if ($error) {
            echo "data: " . json_encode(["error" => $error]) . "\n\n";
        }
        
        Yii::$app->end();
    }
    
    /**
     * –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–∫–∞–∑–∫–∏
     * 
     * @param int $id ID —Å–∫–∞–∑–∫–∏
     * @return string
     */
    public function actionView($id)
    {
        $story = Story::findOne($id);
        
        if (!$story) {
            throw new NotFoundHttpException("–°–∫–∞–∑–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        }
        
        return $this->render("view", ["story" => $story]);
    }
    
    /**
     * –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–∞–∑–æ–∫
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–∫–∞–∑–æ–∫
     * - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —è–∑—ã–∫—É –∏ –≤–æ–∑—Ä–∞—Å—Ç—É
     * - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
     * 
     * @return string
     */
    public function actionHistory()
    {
        $query = Story::find()->orderBy(["created_at" => SORT_DESC]);
        
        // –§–∏–ª—å—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        $language = Yii::$app->request->get("language");
        $age = Yii::$app->request->get("age");
        
        if ($language) {
            $query->andWhere(["language" => $language]);
        }
        
        if ($age) {
            $query->andWhere(["age" => $age]);
        }
        
        $dataProvider = new ActiveDataProvider([
            "query" => $query,
            "pagination" => [
                "pageSize" => 20,
            ],
        ]);
        
        return $this->render("history", [
            "dataProvider" => $dataProvider,
        ]);
    }
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:**
- üîÑ **SSE –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ streaming –¥–∞–Ω–Ω—ã—Ö
- üíæ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- üóÑÔ∏è **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –∑–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤—ã—Ö —Å–∫–∞–∑–æ–∫ –≤ –ë–î
- üö´ **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏** - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è real-time —Ä–∞–±–æ—Ç—ã
- üõ°Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- üìÑ **CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏** - –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
- üîç **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è** - —É–¥–æ–±–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏

#### `models/Story.php` - ActiveRecord –º–æ–¥–µ–ª—å

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php
class Story extends ActiveRecord
{
    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã
     * 
     * @return string –ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
     */
    public static function tableName()
    {
        return "story";
    }
    
    /**
     * –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
     * 
     * –í–∞–ª–∏–¥–∞—Ü–∏—è:
     * - age: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –¥–∏–∞–ø–∞–∑–æ–Ω 1-18
     * - language: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, —Ç–æ–ª—å–∫–æ ru/kk
     * - characters: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, –≤–∞–ª–∏–¥–Ω—ã–π JSON
     * - content: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞
     * 
     * @return array –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    public function rules()
    {
        return [
            [["age", "language", "characters", "content"], "required"],
            ["age", "integer", "min" => 1, "max" => 18],
            ["language", "in", "range" => ["ru", "kk"]],
            ["language", "string", "max" => 2],
            ["characters", "string"],
            ["content", "string", "min" => 50],
        ];
    }
    
    /**
     * –ú–µ—Ç–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º
     * 
     * @return array –ß–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
     */
    public function attributeLabels()
    {
        return [
            "id" => "ID",
            "age" => "–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞",
            "language" => "–Ø–∑—ã–∫",
            "characters" => "–ü–µ—Ä—Å–æ–Ω–∞–∂–∏",
            "content" => "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∫–∞–∑–∫–∏",
            "created_at" => "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è",
        ];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ JSON
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JSON –ø–æ–ª–µ characters
     * - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–π –ø—É—Å—Ç–æ–≥–æ –ø–æ–ª—è
     * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∏–º–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * 
     * @return array –ú–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     */
    public function getCharactersArray(): array
    {
        return $this->characters ? json_decode($this->characters, true) : [];
    }
    
    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ JSON
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –ö–æ–¥–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –≤ JSON
     * - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç JSON_UNESCAPED_UNICODE –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
     * - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
     * 
     * @param array $chars –ú–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     */
    public function setCharactersArray(array $chars): void
    {
        // JSON_UNESCAPED_UNICODE —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É –≤ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ–º –≤–∏–¥–µ
        $this->characters = json_encode($chars, JSON_UNESCAPED_UNICODE);
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –£–¥–∞–ª—è–µ—Ç HTML —Ç–µ–≥–∏ –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
     * - –û–±—Ä–µ–∑–∞–µ—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
     * - –î–æ–±–∞–≤–ª—è–µ—Ç –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –ø—Ä–∏ –æ–±—Ä–µ–∑–∫–µ
     * - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å UTF-8
     * 
     * @param int $length –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø—Ä–µ–≤—å—é
     * @return string –ü—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
     */
    public function getPreview(int $length = 100): string
    {
        $text = strip_tags($this->content);
        if (mb_strlen($text) > $length) {
            return mb_substr($text, 0, $length) . "...";
        }
        return $text;
    }
    
    /**
     * –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
     * 
     * @return string –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ d.m.Y H:i
     */
    public function getFormattedDate(): string
    {
        return date("d.m.Y H:i", strtotime($this->created_at));
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —è–∑—ã–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
     * 
     * @return string "–†—É—Å—Å–∫–∏–π" –∏–ª–∏ "–ö–∞–∑–∞—Ö—Å–∫–∏–π"
     */
    public function getLanguageName(): string
    {
        return $this->language === "ru" ? "–†—É—Å—Å–∫–∏–π" : "–ö–∞–∑–∞—Ö—Å–∫–∏–π";
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç–Ω—É—é –≥—Ä—É–ø–ø—É
     * 
     * @return string –ù–∞–∑–≤–∞–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
     */
    public function getAgeGroup(): string
    {
        if ($this->age <= 3) return "–î–æ—à–∫–æ–ª—å–Ω–∏–∫–∏ (1-3 –≥–æ–¥–∞)";
        if ($this->age <= 6) return "–ú–ª–∞–¥—à–∏–µ (4-6 –ª–µ—Ç)";
        if ($this->age <= 10) return "–°—Ä–µ–¥–Ω–∏–µ (7-10 –ª–µ—Ç)";
        return "–°—Ç–∞—Ä—à–∏–µ (11-18 –ª–µ—Ç)";
    }
    
    /**
     * –ü–æ–∏—Å–∫ —Å–∫–∞–∑–æ–∫ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
     * 
     * @param array $params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
     * @return ActiveQuery
     */
    public static function findByParams($params = [])
    {
        $query = self::find();
        
        if (!empty($params["language"])) {
            $query->andWhere(["language" => $params["language"]]);
        }
        
        if (!empty($params["age"])) {
            $query->andWhere(["age" => $params["age"]]);
        }
        
        if (!empty($params["characters"])) {
            $query->andWhere(["like", "characters", $params["characters"]]);
        }
        
        return $query;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–∫–∞–∑–∫–∞–º
     * 
     * @return array –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
     */
    public static function getStatistics()
    {
        return [
            "total" => self::find()->count(),
            "by_language" => self::find()
                ->select(["language", "COUNT(*) as count"])
                ->groupBy("language")
                ->asArray()
                ->all(),
            "by_age" => self::find()
                ->select(["age", "COUNT(*) as count"])
                ->groupBy("age")
                ->orderBy("age")
                ->asArray()
                ->all(),
        ];
    }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ActiveRecord:**
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- üîó **–°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- üìù **–ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ** - —É–¥–æ–±–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–∞–º–∏
- üõ°Ô∏è **SQL –∏–Ω—ä–µ–∫—Ü–∏–∏** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞
- üîç **–ì–∏–±–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã** - –º–æ—â–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–∏—Å–∫–∞
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- üè∑Ô∏è **–ê—Ç—Ä–∏–±—É—Ç—ã** - —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –º–µ—Ç–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç—ã

#### `models/StoryForm.php` - –§–æ—Ä–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php
class StoryForm extends Model
{
    public $age;           // –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞
    public $language;      // –Ø–∑—ã–∫ —Å–∫–∞–∑–∫–∏ (ru/kk)
    public $characters = []; // –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    
    /**
     * –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
     * 
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
     * - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: age, language, characters
     * - –í–æ–∑—Ä–∞—Å—Ç: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 18 –ª–µ—Ç
     * - –Ø–∑—ã–∫: —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è 'ru' –∏–ª–∏ 'kk'
     * - –ü–µ—Ä—Å–æ–Ω–∞–∂–∏: –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
     * 
     * @return array –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    public function rules()
    {
        return [
            [['age', 'language', 'characters'], 'required'],
            ['age', 'integer', 'min' => 1, 'max' => 18],
            ['language', 'in', 'range' => ['ru', 'kk']],
            ['characters', 'each', 'rule' => ['string']],
            ['characters', 'validateCharactersCount'], // –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä
            ['characters', 'validateCharactersUnique'], // –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        ];
    }
    
    /**
     * –ú–µ—Ç–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º
     * 
     * @return array –ß–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
     */
    public function attributeLabels()
    {
        return [
            'age' => '–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞',
            'language' => '–Ø–∑—ã–∫ —Å–∫–∞–∑–∫–∏',
            'characters' => '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å–∫–∞–∑–∫–∏',
        ];
    }
    
    /**
     * –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * 
     * –õ–æ–≥–∏–∫–∞:
     * - –ú–∏–Ω–∏–º—É–º 2 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π —Å–∫–∞–∑–∫–∏
     * - –ú–∞–∫—Å–∏–º—É–º 5 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç–∏ —Å—é–∂–µ—Ç–∞
     * 
     * @param string $attribute –ò–º—è –∞—Ç—Ä–∏–±—É—Ç–∞
     * @param array $params –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     */
    public function validateCharactersCount($attribute, $params)
    {
        $count = count($this->$attribute);
        
        if ($count < 2) {
            $this->addError($attribute, '–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π —Å–∫–∞–∑–∫–∏');
        }
        
        if ($count > 5) {
            $this->addError($attribute, '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ –±–æ–ª–µ–µ 5 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π');
        }
    }
    
    /**
     * –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä: –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * 
     * @param string $attribute –ò–º—è –∞—Ç—Ä–∏–±—É—Ç–∞
     * @param array $params –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     */
    public function validateCharactersUnique($attribute, $params)
    {
        $uniqueChars = array_unique($this->$attribute);
        if (count($uniqueChars) !== count($this->$attribute)) {
            $this->addError($attribute, '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è');
        }
    }
    
    /**
     * –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (—Ä—É—Å—Å–∫–∏–µ + –∫–∞–∑–∞—Ö—Å–∫–∏–µ)
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—É–ª—å—Ç—É—Ä–∞–º
     * - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏–π –¥–ª—è –∫–∞–∑–∞—Ö—Å–∫–∏—Ö –∏–º–µ–Ω
     * - –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * 
     * @return array –ê—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     */
    public static function getCharacterOptions()
    {
        return [
            // –†—É—Å—Å–∫–∏–µ —Å–∫–∞–∑–æ—á–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
            '–ó–∞—è—Ü' => '–ó–∞—è—Ü',
            '–í–æ–ª–∫' => '–í–æ–ª–∫',
            '–õ–∏—Å–∞' => '–õ–∏—Å–∞',
            '–ú–µ–¥–≤–µ–¥—å' => '–ú–µ–¥–≤–µ–¥—å',
            '–ò–≤–∞–Ω-—Ü–∞—Ä–µ–≤–∏—á' => '–ò–≤–∞–Ω-—Ü–∞—Ä–µ–≤–∏—á',
            '–ë–∞–±–∞-–Ø–≥–∞' => '–ë–∞–±–∞-–Ø–≥–∞',
            '–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π' => '–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π',
            '–í–∞—Å–∏–ª–∏—Å–∞ –ü—Ä–µ–º—É–¥—Ä–∞—è' => '–í–∞—Å–∏–ª–∏—Å–∞ –ü—Ä–µ–º—É–¥—Ä–∞—è',
            
            // –ö–∞–∑–∞—Ö—Å–∫–∏–µ —Å–∫–∞–∑–æ—á–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
            '–ê–ª–¥–∞—Ä –ö”©—Å–µ' => '–ê–ª–¥–∞—Ä –ö”©—Å–µ',
            '”ò–π–µ–ª –ê—Ä—Å—Ç–∞–Ω' => '”ò–π–µ–ª –ê—Ä—Å—Ç–∞–Ω (–ñ–µ–Ω—â–∏–Ω–∞-–ª–µ–≤)',
            '–ï—Ä –¢”©—Å—Ç—ñ–∫' => '–ï—Ä –¢”©—Å—Ç—ñ–∫',
            '–ê–ª–ø–∞–º—ã—Å –±–∞—Ç—ã—Ä' => '–ê–ª–ø–∞–º—ã—Å –±–∞—Ç—ã—Ä',
            '–ñ–∞–ª–º–∞—É—ã–∑ –∫–µ–º–ø—ñ—Ä' => '–ñ–∞–ª–º–∞—É—ã–∑ –∫–µ–º–ø—ñ—Ä (–ë–∞–±–∞-–Ø–≥–∞)',
            '–¢”©–ª–µ–≥–µ–Ω –¢–æ“õ—Ç–∞—Ä–æ–≤' => '–¢”©–ª–µ–≥–µ–Ω –¢–æ“õ—Ç–∞—Ä–æ–≤',
            '“ö–æ–±—ã–ª–∞–Ω–¥—ã –±–∞—Ç—ã—Ä' => '“ö–æ–±—ã–ª–∞–Ω–¥—ã –±–∞—Ç—ã—Ä',
            
            // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
            '–î—Ä–∞–∫–æ–Ω' => '–î—Ä–∞–∫–æ–Ω',
            '–§–µ—è' => '–§–µ—è',
            '–ì–Ω–æ–º' => '–ì–Ω–æ–º',
            '–í–µ–¥—å–º–∞' => '–í–µ–¥—å–º–∞',
            '–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞' => '–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞',
            '–ö–æ—Ä–æ–ª—å' => '–ö–æ—Ä–æ–ª—å',
        ];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–æ —è–∑—ã–∫—É
     * 
     * @param string $language –ö–æ–¥ —è–∑—ã–∫–∞ (ru/kk)
     * @return array –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     */
    public static function getCharactersByLanguage($language)
    {
        $all = self::getCharacterOptions();
        
        if ($language === 'ru') {
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º
            $russian = [
                '–ó–∞—è—Ü' => '–ó–∞—è—Ü',
                '–í–æ–ª–∫' => '–í–æ–ª–∫',
                '–õ–∏—Å–∞' => '–õ–∏—Å–∞',
                '–ú–µ–¥–≤–µ–¥—å' => '–ú–µ–¥–≤–µ–¥—å',
                '–ò–≤–∞–Ω-—Ü–∞—Ä–µ–≤–∏—á' => '–ò–≤–∞–Ω-—Ü–∞—Ä–µ–≤–∏—á',
                '–ë–∞–±–∞-–Ø–≥–∞' => '–ë–∞–±–∞-–Ø–≥–∞',
            ];
            return array_merge($russian, $all);
        }
        
        if ($language === 'kk') {
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–∞–∑–∞—Ö—Å–∫–∏–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º
            $kazakh = [
                '–ê–ª–¥–∞—Ä –ö”©—Å–µ' => '–ê–ª–¥–∞—Ä –ö”©—Å–µ',
                '”ò–π–µ–ª –ê—Ä—Å—Ç–∞–Ω' => '”ò–π–µ–ª –ê—Ä—Å—Ç–∞–Ω (–ñ–µ–Ω—â–∏–Ω–∞-–ª–µ–≤)',
                '–ï—Ä –¢”©—Å—Ç—ñ–∫' => '–ï—Ä –¢”©—Å—Ç—ñ–∫',
                '–ê–ª–ø–∞–º—ã—Å –±–∞—Ç—ã—Ä' => '–ê–ª–ø–∞–º—ã—Å –±–∞—Ç—ã—Ä',
                '–ñ–∞–ª–º–∞—É—ã–∑ –∫–µ–º–ø—ñ—Ä' => '–ñ–∞–ª–º–∞—É—ã–∑ –∫–µ–º–ø—ñ—Ä (–ë–∞–±–∞-–Ø–≥–∞)',
            ];
            return array_merge($kazakh, $all);
        }
        
        return $all;
    }
    
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è API
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
     * - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Python API
     * 
     * @return array –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è API
     */
    public function toApiData()
    {
        return [
            'age' => (int)$this->age,
            'language' => $this->language,
            'characters' => array_values($this->characters),
        ];
    }
    
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –æ—Ç–≤–µ—Ç–∞
     * 
     * @param array $data –î–∞–Ω–Ω—ã–µ –æ—Ç API
     */
    public function loadFromApiData($data)
    {
        $this->age = $data['age'] ?? null;
        $this->language = $data['language'] ?? null;
        $this->characters = $data['characters'] ?? [];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
     * 
     * @return string –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
     */
    public function getAgeGroupDescription()
    {
        if ($this->age <= 3) return '–ú–∞–ª—ã—à (1-3 –≥–æ–¥–∞) - –ø—Ä–æ—Å—Ç—ã–µ —Å–∫–∞–∑–∫–∏';
        if ($this->age <= 6) return '–î–æ—à–∫–æ–ª—å–Ω–∏–∫ (4-6 –ª–µ—Ç) - —Å–∫–∞–∑–∫–∏ —Å –º–æ—Ä–∞–ª—å—é';
        if ($this->age <= 10) return '–ú–ª–∞–¥—à–∏–π —à–∫–æ–ª—å–Ω–∏–∫ (7-10 –ª–µ—Ç) - –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è';
        return '–ü–æ–¥—Ä–æ—Å—Ç–æ–∫ (11-18 –ª–µ—Ç) - —Å–ª–æ–∂–Ω—ã–µ —Å—é–∂–µ—Ç—ã';
    }
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã:**
- ‚úÖ **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è + —Å–µ—Ä–≤–µ—Ä–Ω–∞—è
- üåç **–ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è** - –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —Ä–∞–∑–Ω—ã—Ö –Ω–∞—Ä–æ–¥–æ–≤
- üîÑ **–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è Python API
- üéØ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- üè∑Ô∏è **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –ø–æ —è–∑—ã–∫—É
- üìä **–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã** - –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- üîç **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - —É–º–Ω—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π

#### `services/StoryApiService.php` - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Python API

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php
class StoryApiService extends Component
{
    public $apiUrl;        // URL Python API
    public $timeout = 60;  // –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
    public $retries = 3;   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
    private $_client;      // Guzzle HTTP –∫–ª–∏–µ–Ω—Ç
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –°–æ–∑–¥–∞–Ω–∏–µ Guzzle HTTP –∫–ª–∏–µ–Ω—Ç–∞
     * - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
     * - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
     */
    public function init()
    {
        parent::init();
        
        $this->_client = new Client([
            'base_uri' => $this->apiUrl,
            'timeout' => $this->timeout,
            'verify' => false, // –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            'headers' => [
                'Content-Type' => 'application/json',
                'Accept' => 'text/plain',
                'User-Agent' => 'Yii2-Story-Generator/1.0',
            ],
        ]);
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–∫–∏ —Å –ø–æ—Ç–æ–∫–æ–≤—ã–º –æ—Ç–≤–µ—Ç–æ–º
     * 
     * –ö–ª—é—á–µ–≤–æ–π –º–µ—Ç–æ–¥ –¥–ª—è real-time –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
     * 
     * –ü—Ä–æ—Ü–µ—Å—Å:
     * 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –∫ Python API
     * 2. –í–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º streaming
     * 3. –ß–∏—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ —á–∞—Å—Ç—è–º (—á–∞–Ω–∫–∞–º–∏)
     * 4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç UTF-8 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
     * 5. –í—ã–∑—ã–≤–∞–µ—Ç callback –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
     * 6. –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
     * 7. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
     * 
     * @param array $data –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     * @param callable $callback –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∞–Ω–∫–æ–≤
     * @throws Exception –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
     */
    public function generateStoryStream($data, $callback = null)
    {
        try {
            Yii::info("Starting story generation", __METHOD__);
            
            $response = $this->_client->post('/generate_story', [
                'json' => $data,
                'stream' => true,  // –í–∫–ª—é—á–∞–µ–º streaming
            ]);
            
            $body = $response->getBody();
            $buffer = '';
            $totalLength = 0;
            $maxBufferLength = 8192;  // 8KB –ª–∏–º–∏—Ç –±—É—Ñ–µ—Ä–∞
            $maxContentLength = 100000; // 100KB –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            
            while (!$body->eof()) {
                $chunk = $body->read(1024);
                $buffer .= $chunk;
                $totalLength += strlen($chunk);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –æ–±—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
                if ($totalLength > $maxContentLength) {
                    throw new Exception('Story content too long');
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ UTF-8
                $validPart = $buffer;
                $tail = '';
                
                while ($validPart !== '' && !mb_check_encoding($validPart, 'UTF-8')) {
                    $tail = substr($validPart, -1) . $tail;
                    $validPart = substr($validPart, 0, -1);
                    
                    if (strlen($tail) > 4) break; // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∞
                }
                
                if ($validPart !== '') {
                    if ($callback && is_callable($callback)) {
                        call_user_func($callback, $validPart);
                    }
                    $buffer = $tail;
                }
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞
                if (strlen($buffer) > $maxBufferLength) {
                    $buffer = substr($buffer, -$maxBufferLength);
                }
            }
            
            Yii::info("Story generation completed", __METHOD__);
            
        } catch (GuzzleException $e) {
            Yii::error("API request failed: " . $e->getMessage(), __METHOD__);
            throw new Exception('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏: ' . $e->getMessage());
        }
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Python API
     * 
     * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
     * - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç GET –∑–∞–ø—Ä–æ—Å –Ω–∞ /health
     * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
     * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
     * 
     * @return array –°—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ
     */
    public function healthCheck()
    {
        try {
            $response = $this->_client->get('/health', [
                'timeout' => 5, // –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è health check
            ]);
            
            $data = json_decode($response->getBody()->getContents(), true);
            
            return [
                'status' => 'healthy',
                'api_url' => $this->apiUrl,
                'response_time' => $response->getHeaderLine('X-Response-Time'),
                'service_info' => $data,
            ];
            
        } catch (GuzzleException $e) {
            Yii::error("Health check failed: " . $e->getMessage(), __METHOD__);
            return [
                'status' => 'error',
                'message' => $e->getMessage(),
                'api_url' => $this->apiUrl,
            ];
        }
    }
    
    /**
     * –¢–µ—Å—Ç–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–±–µ–∑ streaming)
     * 
     * @param array $data –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     * @return array –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     */
    public function testGeneration($data)
    {
        try {
            $response = $this->_client->post('/generate_story', [
                'json' => $data,
                'timeout' => 30,
            ]);
            
            return [
                'success' => true,
                'content' => $response->getBody()->getContents(),
                'status_code' => $response->getStatusCode(),
            ];
            
        } catch (GuzzleException $e) {
            return [
                'success' => false,
                'error' => $e->getMessage(),
            ];
        }
    }
    
    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥–µ–ª–∏
     * 
     * @return array –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏ OpenAI
     */
    public function getModelInfo()
    {
        try {
            $response = $this->_client->get('/model_info');
            return json_decode($response->getBody()->getContents(), true);
        } catch (GuzzleException $e) {
            return ['error' => $e->getMessage()];
        }
    }
    
    /**
     * –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
     * 
     * @param callable $operation –û–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
     * @param int $maxAttempts –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
     * @return mixed –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
     */
    private function retryWithBackoff($operation, $maxAttempts = 3)
    {
        $attempt = 0;
        
        while ($attempt < $maxAttempts) {
            try {
                return $operation();
            } catch (Exception $e) {
                $attempt++;
                
                if ($attempt >= $maxAttempts) {
                    throw $e;
                }
                
                $delay = min(1000000, 100000 * pow(2, $attempt - 1)); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
                usleep($delay);
            }
        }
    }
}
```

**–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞:**
- üîÑ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π streaming** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å UTF-8 —á–∞–Ω–∫–∞–º–∏
- üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏** - –ª–∏–º–∏—Ç—ã –±—É—Ñ–µ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- üîç **Health checks** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- ‚ö° **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–æ–≤
- üîÑ **Retry –º–µ—Ö–∞–Ω–∏–∑–º** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- üìä **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- ‚è±Ô∏è **–¢–∞–π–º–∞—É—Ç—ã** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### üé® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

#### `views/default/index.php` - –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

```php
<?php
/* @var $this yii\web\View */
/* @var $model app\modules\story\models\StoryForm */
/* @var $form yii\widgets\ActiveForm */

use yii\helpers\Html;
use yii\widgets\ActiveForm;
use app\modules\story\models\StoryForm;

$this->title = '–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–∑–∫–∏';
$this->params['breadcrumbs'][] = $this->title;
?>

<!-- üé® –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
<div class="story-header text-center mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">
        <i class="bi bi-magic"></i> –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ª—à–µ–±–Ω–æ–π —Å–∫–∞–∑–∫–∏
    </h1>
    <p class="lead text-muted">
        –°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å–∫–∞–∑–∫—É –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
    </p>
</div>

<!-- üìù –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏ -->
<div class="row justify-content-center">
    <div class="col-lg-8">
        <?php $form = ActiveForm::begin([
            'id' => 'story-form',
            'options' => ['class' => 'story-form needs-validation', 'novalidate' => true],
            'fieldConfig' => [
                'template' => "{label}\n{input}\n{error}",
                'labelOptions' => ['class' => 'form-label'],
                'errorOptions' => ['class' => 'invalid-feedback'],
            ],
        ]); ?>

        <!-- üë∂ –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ -->
        <div class="mb-4 form-section">
            <div class="form-section-icon">üë∂</div>
            <?= $form->field($model, 'age')->dropDownList([
                '1' => '1 –≥–æ–¥ - —Å–∞–º—ã–µ –ø—Ä–æ—Å—Ç—ã–µ —Å–∫–∞–∑–∫–∏',
                '2' => '2 –≥–æ–¥–∞ - –∫–æ—Ä–æ—Ç–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏',
                '3' => '3 –≥–æ–¥–∞ - —Å–∫–∞–∑–∫–∏ —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏',
                '4' => '4 –≥–æ–¥–∞ - —Å–∫–∞–∑–∫–∏ —Å –º–æ—Ä–∞–ª—å—é',
                '5' => '5 –ª–µ—Ç - –ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏',
                '6' => '6 –ª–µ—Ç - –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Å—é–∂–µ—Ç—ã',
                '7' => '7 –ª–µ—Ç - —Å–∫–∞–∑–∫–∏ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏',
                '8' => '8 –ª–µ—Ç - –≤–æ–ª—à–µ–±–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏',
                '9' => '9 –ª–µ—Ç - –≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–µ —Å–∫–∞–∑–∫–∏',
                '10' => '10 –ª–µ—Ç - —Å–ª–æ–∂–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏',
            ], [
                'prompt' => '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞...',
                'class' => 'form-select form-select-lg',
                'id' => 'age-select',
            ])->label('–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞', ['class' => 'form-label fw-bold fs-5']) ?>
            
            <!-- üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É -->
            <div id="age-hint" class="form-text mt-2">
                <i class="bi bi-info-circle"></i> 
                <span id="age-description">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏</span>
            </div>
        </div>

        <!-- üåç –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ -->
        <div class="mb-4 form-section">
            <div class="form-section-icon">üåç</div>
            <?= $form->field($model, 'language')->radioList([
                'ru' => '<i class="bi bi-flag"></i> –†—É—Å—Å–∫–∏–π —è–∑—ã–∫',
                'kk' => '<i class="bi bi-flag"></i> “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ (–ö–∞–∑–∞—Ö—Å–∫–∏–π)',
            ], [
                'class' => 'language-options',
                'item' => function ($index, $label, $name, $checked, $value) {
                    $id = "lang-{$value}";
                    $checkedAttr = $checked ? 'checked' : '';
                    return "<div class='form-check form-check-inline me-4'>
                        <input class='form-check-input' type='radio' name='{$name}' 
                               id='{$id}' value='{$value}' {$checkedAttr}>
                        <label class='form-check-label' for='{$id}'>
                            {$label}
                        </label>
                    </div>";
                },
            ])->label('–Ø–∑—ã–∫ —Å–∫–∞–∑–∫–∏', ['class' => 'form-label fw-bold fs-5']) ?>
        </div>

        <!-- üé≠ –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
        <div class="mb-4 form-section">
            <div class="form-section-icon">üé≠</div>
            <?= $form->field($model, 'characters')
                ->checkboxList(StoryForm::getCharacterOptions(), [
                    'class' => 'characters-grid',
                    'item' => function ($index, $label, $name, $checked, $value) {
                        $id = "char-{$index}";
                        $checkedAttr = $checked ? 'checked' : '';
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                        $icon = $this->getCharacterIcon($value);
                        
                        return "<div class='character-item'>
                            <input type='checkbox' id='{$id}' class='character-input' 
                                   name='{$name}' value='{$value}' {$checkedAttr}>
                            <label class='character-label' for='{$id}'>
                                <span class='character-icon'>{$icon}</span>
                                <span class='character-name'>{$label}</span>
                            </label>
                        </div>";
                    },
                ])
                ->label('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (2-5 —à—Ç—É–∫)', ['class' => 'form-label fw-bold fs-5']) ?>
            
            <!-- üìä –°—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
            <div class="character-counter mt-2">
                <small class="text-muted">
                    –í—ã–±—Ä–∞–Ω–æ: <span id="selected-count" class="fw-bold">0</span> –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                </small>
            </div>
        </div>

        <!-- ‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div class="text-center mt-5">
            <?= Html::submitButton(
                '<i class="bi bi-magic"></i> –°–æ–∑–¥–∞—Ç—å –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É',
                [
                    'class' => 'btn btn-create btn-lg fw-bold shadow-lg px-5 py-3',
                    'id' => 'create-story-btn',
                    'disabled' => true,
                ]
            ) ?>
        </div>

        <?php ActiveForm::end(); ?>
    </div>
</div>

<!-- üé≠ JavaScript –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<script>
// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function getCharacterIcon(character) {
    const icons = {
        '–ó–∞—è—Ü': 'üê∞', '–í–æ–ª–∫': 'üê∫', '–õ–∏—Å–∞': 'ü¶ä', '–ú–µ–¥–≤–µ–¥—å': 'üêª',
        '–ò–≤–∞–Ω-—Ü–∞—Ä–µ–≤–∏—á': 'ü§¥', '–ë–∞–±–∞-–Ø–≥–∞': 'üßô‚Äç‚ôÄÔ∏è', '–î—Ä–∞–∫–æ–Ω': 'üêâ',
        '–§–µ—è': 'üßö‚Äç‚ôÄÔ∏è', '–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞': 'üë∏', '–ö–æ—Ä–æ–ª—å': 'ü§¥'
    };
    return icons[character] || 'üé≠';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function updateCharacterCounter() {
    const checked = document.querySelectorAll('.character-input:checked').length;
    const counter = document.getElementById('selected-count');
    const button = document.getElementById('create-story-btn');
    
    counter.textContent = checked;
    
    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
    if (checked >= 2 && checked <= 5) {
        button.disabled = false;
        counter.classList.remove('text-danger');
        counter.classList.add('text-success');
    } else {
        button.disabled = true;
        counter.classList.remove('text-success');
        if (checked > 5) {
            counter.classList.add('text-danger');
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
function updateAgeDescription() {
    const select = document.getElementById('age-select');
    const description = document.getElementById('age-description');
    const descriptions = {
        '1': '–ú–∞–ª—ã—à–∞–º –Ω—É–∂–Ω—ã –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–µ —Å–∫–∞–∑–∫–∏ —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏',
        '2': '–ö–æ—Ä–æ—Ç–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏',
        '3': '–°–∫–∞–∑–∫–∏ —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è —Ñ—Ä–∞–∑–∞–º–∏ –∏ –∑–≤—É–∫–∞–º–∏',
        '4': '–ò—Å—Ç–æ—Ä–∏–∏ —Å –ø—Ä–æ—Å—Ç–æ–π –º–æ—Ä–∞–ª—å—é –∏ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –≥–µ—Ä–æ—è–º–∏',
        '5': '–ü—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Å—é–∂–µ—Ç–∞',
        '6': '–ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Å—é–∂–µ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏',
        '7': '–°–∫–∞–∑–∫–∏ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞–º–∏ –≥–µ—Ä–æ–µ–≤',
        '8': '–í–æ–ª—à–µ–±–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–Ω—Ç–∞–∑–∏–µ–π',
        '9': '–ì–µ—Ä–æ–∏—á–µ—Å–∫–∏–µ —Å–∫–∞–∑–∫–∏ —Å –¥–æ–±—Ä—ã–º–∏ –ø–æ—Å—Ç—É–ø–∫–∞–º–∏',
        '10': '–°–ª–æ–∂–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–≤'
    };
    
    description.textContent = descriptions[select.value] || '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    // –°—á–µ—Ç—á–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    document.querySelectorAll('.character-input').forEach(checkbox => {
        checkbox.addEventListener('change', updateCharacterCounter);
    });
    
    // –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
    document.getElementById('age-select').addEventListener('change', updateAgeDescription);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateCharacterCounter();
    updateAgeDescription();
});
</script>
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UI:**
- üé® **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω** - Bootstrap 5 —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
- üì± **Responsive** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚ú® **–ê–Ω–∏–º–∞—Ü–∏–∏** - –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∏ –º–∏–∫—Ä–æ-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- üé≠ **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –ø–æ–Ω—è—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
- üîÑ **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- üìä **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- üéØ **–£–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞** - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–æ–º–æ—â—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üåç **–ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è** - —Ñ–ª–∞–≥–∏ –∏ –∏–∫–æ–Ω–∫–∏ —è–∑—ã–∫–æ–≤

#### `views/default/stream.php` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

```php
<?php
/* @var $this yii\web\View */
/* @var $formData array */

use yii\helpers\Url;
use yii\helpers\Html;

$this->title = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–∫–∏';
$this->params['breadcrumbs'][] = ['label' => '–°–∫–∞–∑–∫–∏', 'url' => ['index']];
$this->params['breadcrumbs'][] = $this->title;

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ marked.js –¥–ª—è Markdown
$this->registerJsFile('https://cdn.jsdelivr.net/npm/marked/marked.min.js', [
    'depends' => [\yii\web\JqueryAsset::class]
]);
?>

<!-- üé® –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
<div class="stream-header text-center mb-4">
    <h1 class="display-5 fw-bold text-primary">
        <i class="bi bi-magic"></i> –í–æ–ª—à–µ–±–Ω–∞—è —Å–∫–∞–∑–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è...
    </h1>
    <p class="lead text-muted">
        –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –ø–∏—à–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å
    </p>
</div>

<!-- üìä –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
<div class="progress-container mb-4">
    <div class="progress" style="height: 8px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 0%"></div>
    </div>
    <div class="text-center mt-2">
        <small id="progress-text" class="text-muted">
            <i class="bi bi-hourglass-split"></i> –ù–∞—á–∏–Ω–∞–µ–º —Ç–≤–æ—Ä–∏—Ç—å –≤–æ–ª—à–µ–±—Å—Ç–≤–æ...
        </small>
    </div>
</div>

<!-- üìñ –û–±–ª–∞—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∞–∑–∫–∏ -->
<div class="story-container">
    <div id="story-content" class="story-content">
        <!-- –¢–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="placeholder-text text-muted text-center py-5">
            <i class="bi bi-journal-text display-1"></i>
            <p class="mt-3">–í–∞—à–∞ —Å–∫–∞–∑–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</p>
        </div>
    </div>
</div>

<!-- ‚è≥ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading-indicator" class="text-center py-4 loading-pulse">
    <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
    </div>
    <div class="spinner-grow text-secondary mx-2" role="status">
        <span class="visually-hidden">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
    </div>
    <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
    </div>
    <p class="mt-3 text-muted fw-semibold">
        <i class="bi bi-magic"></i> –°–æ–∑–¥–∞—é –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É...
    </p>
    <div class="generation-tips">
        <small class="text-muted d-block mt-2">
            üí° –°–æ–≤–µ—Ç: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø–æ–∫–∞ —Å–∫–∞–∑–∫–∞ –Ω–µ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
        </small>
    </div>
</div>

<!-- üéØ –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç—ã) -->
<div id="action-buttons" class="text-center mt-5" style="display: none;">
    <div class="btn-group" role="group">
        <?= Html::a(
            '<i class="bi bi-arrow-left"></i> –ù–æ–≤–∞—è —Å–∫–∞–∑–∫–∞',
            ['index'],
            ['class' => 'btn btn-outline-primary']
        ) ?>
        
        <?= Html::button(
            '<i class="bi bi-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
            ['class' => 'btn btn-outline-secondary', 'id' => 'copy-btn']
        ) ?>
        
        <?= Html::button(
            '<i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å',
            ['class' => 'btn btn-outline-success', 'id' => 'download-btn']
        ) ?>
        
        <?= Html::button(
            '<i class="bi bi-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
            ['class' => 'btn btn-outline-info', 'id' => 'share-btn']
        ) ?>
    </div>
    
    <?php if (isset($formData['language']) && $formData['language'] === 'ru'): ?>
    <div class="mt-3">
        <?= Html::button(
            '<i class="bi bi-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å —Å–∫–∞–∑–∫—É',
            ['class' => 'btn btn-warning', 'id' => 'tts-btn']
        ) ?>
    </div>
    <?php endif; ?>
</div>

<!-- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
<div id="generation-stats" class="stats-container mt-4" style="display: none;">
    <div class="row text-center">
        <div class="col-md-3">
            <div class="stat-item">
                <i class="bi bi-clock-history text-primary"></i>
                <div class="stat-value" id="time-taken">0 —Å–µ–∫</div>
                <div class="stat-label">–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <i class="bi bi-file-text text-success"></i>
                <div class="stat-value" id="word-count">0 —Å–ª–æ–≤</div>
                <div class="stat-label">–û–±—ä–µ–º —Å–∫–∞–∑–∫–∏</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <i class="bi bi-people text-info"></i>
                <div class="stat-value" id="char-count">0</div>
                <div class="stat-label">–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <i class="bi bi-star text-warning"></i>
                <div class="stat-value" id="age-group"><?= $formData['age'] ?? '?' ?> –ª–µ—Ç</div>
                <div class="stat-label">–í–æ–∑—Ä–∞—Å—Ç</div>
            </div>
        </div>
    </div>
</div>

<!-- üéØ JavaScript –¥–ª—è Server-Sent Events –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const eventSource = new EventSource('<?= Url::to(["generate"]) ?>');
let fullContent = '';
let startTime = Date.now();
let wordCount = 0;
let isGenerating = true;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const storyContent = document.getElementById('story-content');
const loadingIndicator = document.getElementById('loading-indicator');
const actionButtons = document.getElementById('action-buttons');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const generationStats = document.getElementById('generation-stats');

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress(percentage, text) {
    progressBar.style.width = percentage + '%';
    progressText.innerHTML = `<i class="bi bi-hourglass-split"></i> ${text}`;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–ª–æ–≤
function countWords(text) {
    return text.trim().split(/\s+/).filter(word => word.length > 0).length;
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
function formatTime(seconds) {
    if (seconds < 60) return `${seconds} —Å–µ–∫`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes} –º–∏–Ω ${secs} —Å–µ–∫`;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
eventSource.onmessage = function(event) {
    try {
        const data = JSON.parse(event.data);
        
        if (data.chunk) {
            // –£–±–∏—Ä–∞–µ–º placeholder –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —á–∞–Ω–∫–µ
            if (fullContent === '') {
                storyContent.innerHTML = '';
                loadingIndicator.style.display = 'none';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
            const chunk = data.chunk;
            fullContent += chunk;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            const textNode = document.createTextNode(chunk);
            storyContent.appendChild(textNode);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–ª–æ–≤
            wordCount = countWords(fullContent);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
            const progress = Math.min(90, wordCount / 10); // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
            updateProgress(progress, `–ù–∞–ø–∏—Å–∞–Ω–æ ${wordCount} —Å–ª–æ–≤...`);
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∑–∞ —Ç–µ–∫—Å—Ç–æ–º
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        if (data.done) {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            isGenerating = false;
            eventSource.close();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            storyContent.innerHTML = marked.parse(fullContent);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100%
            updateProgress(100, '‚úÖ –°–∫–∞–∑–∫–∞ –≥–æ—Ç–æ–≤–∞!');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            actionButtons.style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const endTime = Date.now();
            const timeTaken = Math.round((endTime - startTime) / 1000);
            
            document.getElementById('time-taken').textContent = formatTime(timeTaken);
            document.getElementById('word-count').textContent = wordCount + ' —Å–ª–æ–≤';
            document.getElementById('char-count').textContent = '<?= count($formData['characters'] ?? []) ?>';
            
            generationStats.style.display = 'block';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            if (data.story_id) {
                window.currentStoryId = data.story_id;
            }
        }
        
        if (data.error) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            isGenerating = false;
            eventSource.close();
            
            storyContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong> ${data.error}
                </div>
            `;
            
            loadingIndicator.style.display = 'none';
            actionButtons.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error parsing SSE data:', error);
    }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
eventSource.onerror = function(event) {
    console.error('SSE error:', event);
    
    if (isGenerating) {
        storyContent.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-wifi-off"></i>
                <strong>–ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</strong><br>
                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            </div>
        `;
        
        loadingIndicator.style.display = 'none';
        isGenerating = false;
    }
};

// –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
document.addEventListener('DOMContentLoaded', function() {
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    document.getElementById('copy-btn')?.addEventListener('click', function() {
        navigator.clipboard.writeText(fullContent).then(() => {
            this.innerHTML = '<i class="bi bi-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            }, 2000);
        });
    });
    
    // –°–∫–∞—á–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    document.getElementById('download-btn')?.addEventListener('click', function() {
        const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `—Å–∫–∞–∑–∫–∞_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    });
    
    // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–∫–∞–∑–∫–æ–π
    document.getElementById('share-btn')?.addEventListener('click', function() {
        if (navigator.share) {
            navigator.share({
                title: '–ú–æ—è –≤–æ–ª—à–µ–±–Ω–∞—è —Å–∫–∞–∑–∫–∞',
                text: fullContent.substring(0, 200) + '...',
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            this.innerHTML = '<i class="bi bi-check"></i> –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
            }, 2000);
        }
    });
    
    // –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (Web Speech API)
    document.getElementById('tts-btn')?.addEventListener('click', function() {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(fullContent);
            utterance.lang = 'ru-RU';
            utterance.rate = 0.9;
            
            speechSynthesis.speak(utterance);
            
            this.innerHTML = '<i class="bi bi-volume-mute"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            this.onclick = function() {
                speechSynthesis.cancel();
                this.innerHTML = '<i class="bi bi-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å —Å–∫–∞–∑–∫—É';
                this.onclick = arguments.callee.caller;
            };
        }
    });
});
</script>
```

**–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UI:**
- ‚ö° **Real-time –ø–µ—á–∞—Ç–∞—é—â–∏–π—Å—è —Ç–µ–∫—Å—Ç** - —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–Ω–æ–π –º–∞—à–∏–Ω–∫–∏
- üìú **Markdown —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥** - –∫—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- üîÑ **–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª** - —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–º —Ç–µ–∫—Å—Ç–æ–º
- ‚ú® **–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** - –≤—Ä–µ–º—è, —Å–ª–æ–≤–∞, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
- üéØ **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏** - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
- üó£Ô∏è **–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ** - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –¥–ª—è —Å–∫–∞–∑–æ–∫
- üì± **Responsive –¥–∏–∑–∞–π–Ω** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- üõ°Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ–µ–≤
- üé® **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI** - Bootstrap 5 —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### `m241206_000000_create_story_table.php` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–∫–∞–∑–æ–∫

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php

class m241206_000000_create_story_table extends Migration
{
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã story
     * 
     * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã:
     * - id: –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á —Å AUTO_INCREMENT
     * - age: –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞ (1-18 –ª–µ—Ç)
     * - language: —è–∑—ã–∫ —Å–∫–∞–∑–∫–∏ (ru/kk)
     * - characters: JSON –º–∞—Å—Å–∏–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
     * - content: —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown
     * - created_at: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
     * 
     * –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
     * - idx-story-created_at: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ
     * - idx-story-language: –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —è–∑—ã–∫—É
     * - idx-story-age: –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
     */
    public function safeUp()
    {
        $this->createTable('{{%story}}', [
            'id' => $this->primaryKey(),
            'age' => $this->integer()->notNull()->comment('–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞'),
            'language' => $this->string(2)->notNull()->comment('–Ø–∑—ã–∫ (ru/kk)'),
            'characters' => $this->text()->notNull()->comment('–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (JSON)'),
            'content' => $this->text()->notNull()->comment('–¢–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏ (Markdown)'),
            'created_at' => $this->timestamp()->notNull()->defaultExpression('CURRENT_TIMESTAMP'),
        ], 'CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE=InnoDB');

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
        $this->createIndex(
            'idx-story-created_at',
            '{{%story}}',
            'created_at'
        );

        $this->createIndex(
            'idx-story-language',
            '{{%story}}',
            'language'
        );

        $this->createIndex(
            'idx-story-age',
            '{{%story}}',
            'age'
        );

        // –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        $this->createIndex(
            'idx-story-language-age',
            '{{%story}}',
            ['language', 'age']
        );
    }

    /**
     * –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
     */
    public function safeDown()
    {
        $this->dropTable('{{%story}}');
    }
}
```

#### `m241207_000000_drop_updated_at_from_story.php` - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php

class m241207_000000_drop_updated_at_from_story extends Migration
{
    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è updated_at
     * 
     * –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
     * - –°–∫–∞–∑–∫–∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
     * - –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
     * - –£–ø—Ä–æ—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
     * - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
     */
    public function safeUp()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        if ($this->db->getTableSchema('{{%story}}')->getColumn('updated_at')) {
            $this->dropColumn('{{%story}}', 'updated_at');
        }
    }

    /**
     * –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è)
     */
    public function safeDown()
    {
        if (!$this->db->getTableSchema('{{%story}}')->getColumn('updated_at')) {
            $this->addColumn('{{%story}}', 'updated_at', $this->timestamp()->defaultExpression('CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'));
        }
    }
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `story`

```sql
CREATE TABLE `story` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `age` int(11) NOT NULL COMMENT '–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞ (1-18 –ª–µ—Ç)',
  `language` varchar(2) NOT NULL COMMENT '–Ø–∑—ã–∫ (ru/kk)',
  `characters` text NOT NULL COMMENT '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (JSON –º–∞—Å—Å–∏–≤)',
  `content` text NOT NULL COMMENT '–¢–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏ (Markdown —Ñ–æ—Ä–º–∞—Ç)',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
  PRIMARY KEY (`id`),
  KEY `idx-story-created_at` (`created_at`) COMMENT '–î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ',
  KEY `idx-story-language` (`language`) COMMENT '–î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —è–∑—ã–∫—É',
  KEY `idx-story-age` (`age`) COMMENT '–î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É',
  KEY `idx-story-language-age` (`language`,`age`) COMMENT '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- üóùÔ∏è **UTF-8 Unicode** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏ –∫–∞–∑–∞—Ö—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
- üìä **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** - –±—ã—Å—Ç—Ä–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
- üìù **JSON —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –≥–∏–±–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- ‚è∞ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
- üöÄ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üîÑ **–ú–∏–≥—Ä–∞—Ü–∏–∏** - –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ë–î
- üìè **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞** - —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è

#### `modules/story/Module.php` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è —Å–∫–∞–∑–æ–∫

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php

namespace app\modules\story;

use yii\base\Module;

/**
 * –ú–æ–¥—É–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫
 * 
 * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
 * - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–¥—É–ª—è
 * - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Python API
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –ø—Ä–∞–≤–∏–ª–∞–º–∏
 * - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
 */
class Module extends Module
{
    /**
     * @var string URL Python API —Å–µ—Ä–≤–∏—Å–∞
     */
    public $pythonApiUrl = 'http://localhost:8001';
    
    /**
     * @var int –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Python API (—Å–µ–∫—É–Ω–¥—ã)
     */
    public $pythonApiTimeout = 60;
    
    /**
     * @var bool –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
     */
    public $debugMode = false;
    
    /**
     * @var array –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OpenAI –º–æ–¥–µ–ª–∏
     */
    public $openaiConfig = [
        'model' => 'gpt-4o-mini',
        'max_tokens' => 2000,
        'temperature' => 0.8,
    ];
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     * 
     * –ü—Ä–æ—Ü–µ—Å—Å:
     * 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     * 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
     * 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     * 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    public function init()
    {
        parent::init();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–ª–∏–∞—Å–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        \Yii::setAlias('@story', __DIR__);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –º–æ–¥—É–ª—è
        $this->setComponents([
            'storyApiService' => [
                'class' => 'app\modules\story\services\StoryApiService',
                'apiUrl' => $this->pythonApiUrl,
                'timeout' => $this->pythonApiTimeout,
            ],
        ]);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ development —Ä–µ–∂–∏–º–µ
        if (YII_DEBUG && $this->debugMode) {
            $this->validateConfiguration();
        }
    }
    
    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è
     * 
     * –ü—Ä–æ–≤–µ—Ä–∫–∏:
     * - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å URL Python API
     * - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
     * - –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ OpenAI
     */
    private function validateConfiguration()
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL —Ñ–æ—Ä–º–∞—Ç–∞
        if (!filter_var($this->pythonApiUrl, FILTER_VALIDATE_URL)) {
            \Yii::error("Invalid Python API URL: {$this->pythonApiUrl}", __METHOD__);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞
        if ($this->pythonApiTimeout <= 0 || $this->pythonApiTimeout > 300) {
            \Yii::warning("Python API timeout may be too high/low: {$this->pythonApiTimeout}", __METHOD__);
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å URL –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–æ–¥—É–ª—è
     * 
     * @return array –ü—Ä–∞–≤–∏–ª–∞ URL
     */
    public function getUrlRules()
    {
        return [
            'story' => 'story/default/index',
            'story/create' => 'story/default/index',
            'story/stream' => 'story/default/stream',
            'story/generate' => 'story/default/generate',
            'story/history' => 'story/default/history',
            'story/view/<id:\d+>' => 'story/default/view',
            'story/delete/<id:\d+>' => 'story/default/delete',
        ];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     * 
     * @return array –≠–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é
     */
    public function getNavigationItems()
    {
        return [
            [
                'label' => '<i class="bi bi-magic"></i> –°–∫–∞–∑–∫–∏',
                'url' => ['/story'],
                'active' => $this->isActiveController('story'),
                'items' => [
                    [
                        'label' => '<i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É',
                        'url' => ['/story'],
                    ],
                    [
                        'label' => '<i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è',
                        'url' => ['/story/history'],
                    ],
                ],
            ],
        ];
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
     * 
     * @param string $controllerId ID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
     * @return bool
     */
    private function isActiveController($controllerId)
    {
        $controller = \Yii::$app->controller;
        return $controller && $controller->module instanceof self && 
               $controller->id === $controllerId;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥—É–ª—è
     * 
     * @return array –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
     */
    public function getModuleStats()
    {
        $storyModel = new \app\modules\story\models\Story();
        
        return [
            'total_stories' => $storyModel::find()->count(),
            'stories_today' => $storyModel::find()
                ->where(['>=', 'created_at', date('Y-m-d')])
                ->count(),
            'api_status' => $this->checkApiStatus(),
            'last_generation' => $this->getLastGenerationTime(),
        ];
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Python API
     * 
     * @return array –°—Ç–∞—Ç—É—Å API
     */
    private function checkApiStatus()
    {
        try {
            $service = $this->get('storyApiService');
            return $service->healthCheck();
        } catch (\Exception $e) {
            return [
                'status' => 'error',
                'message' => $e->getMessage(),
            ];
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     * 
     * @return string|null –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
     */
    private function getLastGenerationTime()
    {
        $lastStory = \app\modules\story\models\Story::find()
            ->orderBy(['created_at' => SORT_DESC])
            ->one();
            
        return $lastStory ? $lastStory->created_at : null;
    }
}
```

---

## üê≥ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### `docker-compose.yml` - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

```yaml
services:
  # PHP + Yii2 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
  php:
    image: yiisoftware/yii2-php:8.2-apache
    container_name: yii-php
    volumes:
      - ../yii2-app:/app  # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    ports:
      - "8000:80"        # –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    depends_on:
      - db
      - story-api
    environment:
      YII_DEBUG: "false"
      YII_ENV: "prod"
    networks:
      - yii-network

  # Python FastAPI –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
  story-api:
    build:
      context: ../python-story-api
    container_name: python-api
    ports:
      - "8001:8000"      # API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
    env_file:
      - ../python-story-api/.env
    environment:
      ENVIRONMENT: "prod"
    volumes:
      - ../python-story-api/app:/app/app  # Live reload
    restart: unless-stopped
    depends_on:
      - db
    networks:
      - yii-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MySQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  db:
    image: mysql:8
    container_name: yii-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: storydb
      MYSQL_USER: user
      MYSQL_PASSWORD: pass
    ports:
      - "3307:3306"      # –î–æ—Å—Ç—É–ø –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    volumes:
      - db_data:/var/lib/mysql  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    networks:
      - yii-network

  # phpMyAdmin –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: yii-phpmyadmin
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: root
    ports:
      - "8081:80"        # –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ë–î
    depends_on:
      - db
    networks:
      - yii-network

networks:
  yii-network:  # –û–±—â–∞—è —Å–µ—Ç—å –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

volumes:
  db_data:     # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ë–î
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
- üîÑ **–ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤** - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- üì¶ **–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ä–µ–¥–∞ –≤–µ–∑–¥–µ
- üöÄ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- üîç **Health checks** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### üìã –ü–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–∑–∫–∏

```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚Üì (–∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É)
üåê Yii2 Frontend (actionIndex)
    ‚Üì (–≤–∞–ª–∏–¥–∞—Ü–∏—è + —Å–µ—Å—Å–∏—è)
üîÑ Redirect ‚Üí /stream
    ‚Üì (JavaScript SSE)
üåê Yii2 (actionGenerate) 
    ‚Üì (–ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)
üêç Python FastAPI (/generate_story)
    ‚Üì (OpenAI GPT –∑–∞–ø—Ä–æ—Å)
ü§ñ OpenAI API
    ‚Üì (streaming –æ—Ç–≤–µ—Ç)
üêç Python API
    ‚Üì (—á–∞–Ω–∫–∏)
üåê Yii2 (SSE –ø—Ä–æ–∫—Å–∏)
    ‚Üì (real-time)
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç)
    ‚Üì (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
üóÑÔ∏è MySQL (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
```

#### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```php
// 1. Yii2 –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
$formData = [
    'age' => 6,
    'language' => 'ru',
    'characters' => ['–ó–∞—è—Ü', '–í–æ–ª–∫', '–õ–∏—Å–∞']
];

// 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Python API
$response = $this->_apiService->generateStoryStream($formData, $callback);

// 3. Python —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç
$systemPrompt = "–¢—ã ‚Äî –¥–µ—Ç—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –í–æ–∑—Ä–∞—Å—Ç: 6 –ª–µ—Ç. –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π...";
$userPrompt = "–ù–∞–ø–∏—à–∏ —Å–∫–∞–∑–∫—É —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏: –ó–∞—è—Ü, –í–æ–ª–∫, –õ–∏—Å–∞";

// 4. –ó–∞–ø—Ä–æ—Å –∫ OpenAI GPT
$stream = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [
        {"role": "system", "content": $systemPrompt},
        {"role": "user", "content": $userPrompt}
    ],
    stream: true
});

// 5. Streaming –ø–µ—Ä–µ–¥–∞—á–∞
foreach ($chunk in $stream) {
    yield $chunk->content;  // "–ñ–∏–ª–∞-–±—ã–ª –≤ –ª–µ—Å—É..."
}

// 6. SSE —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "data: {\"chunk\": \"–ñ–∏–ª–∞-–±—ã–ª –≤ –ª–µ—Å—É...\"}\n\n";

// 7. JavaScript –æ–±—Ä–∞–±–æ—Ç–∫–∞
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.chunk) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        document.getElementById('story-content').textContent += data.chunk;
    }
};
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞

#### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```python
# Python Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è
class StoryRequest(BaseModel):
    age: int = Field(..., gt=0, le=10)  # –¢–æ–ª—å–∫–æ 1-10 –ª–µ—Ç
    language: str = Field(..., pattern="^(ru|kk)$")  # –¢–æ–ª—å–∫–æ ru/kk
    characters: List[str] = Field(..., max_length=10)  # –ú–∞–∫—Å–∏–º—É–º 10 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
```

```php
// Yii2 –≤–∞–ª–∏–¥–∞—Ü–∏—è
public function rules()
{
    return [
        ['age', 'integer', 'min' => 1, 'max' => 18],
        ['language', 'in', 'range' => ['ru', 'kk']],
        ['characters', 'validateCharactersCount'],
    ];
}
```

#### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

- üõ°Ô∏è **CSRF –∑–∞—â–∏—Ç–∞** - –≤—Å–µ —Ñ–æ—Ä–º—ã –∑–∞—â–∏—â–µ–Ω—ã —Ç–æ–∫–µ–Ω–∞–º–∏
- üîí **SQL –∏–Ω—ä–µ–∫—Ü–∏–∏** - ActiveRecord –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- üö´ **XSS –∑–∞—â–∏—Ç–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Yii2
- üîê **CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ API

#### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

```php
// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON
public function setCharactersArray(array $chars): void
{
    $this->characters = json_encode($chars, JSON_UNESCAPED_UNICODE);
}

// –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
<?= Html::encode($story->content) ?>
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# Python –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger.info(f"üìö Generating story: age={request.age}, lang={request.language}")
logger.error(f"‚ùå Error generating story: {str(e)}", exc_info=True)
```

```php
// Yii2 –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
Yii::info("Starting stream generation", __METHOD__);
Yii::error("Stream generation failed: " . $e->getMessage(), __METHOD__);
```

### Health Checks

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
curl http://localhost:8000                    # Yii2
curl http://localhost:8001/health             # Python API
docker exec -it yii-db mysqladmin ping        # MySQL
```

---

## üìÑ –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### Python API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### `.env.example` - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```bash
# OpenAI Configuration
OPENAI_API_KEY=sk-your-openai-api-key-here
OPENAI_MODEL=gpt-4o-mini
OPENAI_BASE_URL=https://api.openai.com/v1

# API Configuration
API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=1

# Security
CORS_ORIGINS=http://localhost:8000,http://127.0.0.1:8000
RATE_LIMIT=100

# Performance
MAX_CONTENT_LENGTH=100000
STREAM_TIMEOUT=300

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s

# Environment
ENVIRONMENT=development
DEBUG=false
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- `OPENAI_API_KEY`: API –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ OpenAI GPT
- `OPENAI_MODEL`: –ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (gpt-4o-mini —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- `API_HOST/PORT`: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—É—Å–∫–∞ FastAPI —Å–µ—Ä–≤–µ—Ä–∞
- `CORS_ORIGINS`: –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `RATE_LIMIT`: –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
- `MAX_CONTENT_LENGTH`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- `STREAM_TIMEOUT`: –¢–∞–π–º–∞—É—Ç –¥–ª—è streaming —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

#### `requirements.txt` - Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:**

```txt
# Web Framework
fastapi==0.104.1
uvicorn[standard]==0.24.0

# OpenAI Integration
openai==1.3.7

# Data Validation
pydantic==2.5.0
pydantic-settings==2.1.0

# HTTP Client
httpx==0.25.2

# Logging and Monitoring
structlog==23.2.0

# Development
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.11.0
flake8==6.1.0

# Production
gunicorn==21.2.0
```

**–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
- `fastapi`: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è API
- `uvicorn`: ASGI —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FastAPI
- `openai`: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç OpenAI API
- `pydantic`: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- `httpx`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç
- `structlog`: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `pytest`: –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### `Dockerfile` - Docker –æ–±—Ä–∞–∑ Python

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```dockerfile
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Python –æ–±—Ä–∞–∑
FROM python:3.10-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY ./app /app/app

# –°–æ–∑–¥–∞–µ–º non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Dockerfile:**
- üêç **Python 3.10-slim**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑
- üîí **Non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: –ü–æ–≤—ã—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üè• **Health check**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- üì¶ **–ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è —Å–±–æ—Ä–∫–∞**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
- ‚ö° **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤

### Yii2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### `composer.json` - PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:**

```json
{
    "name": "yiisoft/yii2-app-advanced",
    "description": "Yii 2 Advanced Project Template with Story Generator",
    "keywords": ["yii2", "framework", "story", "generator", "ai"],
    "homepage": "https://www.yiiframework.com/",
    "type": "project",
    "license": "BSD-3-Clause",
    "support": {
        "issues": "https://github.com/yiisoft/yii2/issues?state=open",
        "forum": "https://www.yiiframework.com/forum/",
        "wiki": "https://www.yiiframework.com/wiki/",
        "irc": "irc://irc.freenode.net/yii"
    },
    "minimum-stability": "stable",
    "require": {
        "php": ">=8.0.0",
        "yiisoft/yii2": "~2.0.45",
        "yiisoft/yii2-bootstrap5": "~2.0.2",
        "yiisoft/yii2-swiftmailer": "~2.1.0",
        "guzzlehttp/guzzle": "~7.5.0",
        "yiisoft/yii2-codeception": "~2.0.0"
    },
    "require-dev": {
        "yiisoft/yii2-debug": "~2.1.0",
        "yiisoft/yii2-gii": "~2.2.0",
        "yiisoft/yii2-faker": "~2.0.0",
        "codeception/codeception": "^5.0.0",
        "codeception/module-filesystem": "^3.0.0",
        "codeception/module-yii2": "^1.1.0",
        "codeception/module-db": "^3.0.0",
        "phpunit/phpunit": "~9.5.0"
    },
    "autoload": {
        "psr-4": {
            "app\\": "app/",
            "app\\modules\\story\\": "modules/story/"
        }
    },
    "config": {
        "process-timeout": 1800,
        "fxp-asset": {
            "enabled": false
        }
    },
    "scripts": {
        "post-create-project-cmd": [
            "yii\\composer\\Installer::postCreateProject"
        ]
    },
    "extra": {
        "yii\\composer\\Installer::postCreateProject": {
            "setPermission": [
                {
                    "runtime": "0777",
                    "web/assets": "0777",
                    "yii": "0755"
                }
            ],
            "generateCookieValidationKey": [
                "config/web.php"
            ]
        }
    }
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
- `yiisoft/yii2`: –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- `yiisoft/yii2-bootstrap5`: Bootstrap 5 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- `guzzlehttp/guzzle`: HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- `codeception/codeception`: –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `yiisoft/yii2-debug`: –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏
- `yiisoft/yii2-gii`: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥–∞

---

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ

#### 1. Streaming —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

```python
# –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–æ–≤
async for chunk in stream:
    if chunk.choices[0].delta.content:
        yield chunk.choices[0].delta.content
        await asyncio.sleep(0.001)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
```

#### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

```php
// –õ–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
$maxBufferLength = 8192;    // 8KB –ª–∏–º–∏—Ç –±—É—Ñ–µ—Ä–∞
$maxContentLength = 100000; // 100KB –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞

// –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
$fullContent = null;
unset($fullContent);
```

#### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx-story-created_at ON story(created_at);
CREATE INDEX idx-story-language ON story(language);
CREATE INDEX idx-story-age ON story(age);
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç—ã Python API

#### `test_api.py` - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã API

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
import pytest
import asyncio
from fastapi.testclient import TestClient
from app.main import app
from app.models import StoryRequest
from app.services import StoryGeneratorService

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
client = TestClient(app)

class TestStoryGeneration:
    """–¢–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–æ–∫"""
    
    def test_valid_story_request(self):
        """–¢–µ—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é"""
        response = client.post("/generate_story", json={
            "age": 6,
            "language": "ru", 
            "characters": ["–ó–∞—è—Ü", "–í–æ–ª–∫", "–õ–∏—Å–∞"]
        })
        
        assert response.status_code == 200
        assert response.headers["content-type"] == "text/plain; charset=utf-8"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏
        content = response.content.decode('utf-8')
        assert len(content) > 50  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–∫–∞–∑–∫–∏
        assert any(word in content.lower() for word in ["–∑–∞—è—Ü", "–≤–æ–ª–∫", "–ª–∏—Å–∞"])
    
    def test_invalid_age(self):
        """–¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞"""
        response = client.post("/generate_story", json={
            "age": 25,  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç
            "language": "ru",
            "characters": ["–ó–∞—è—Ü"]
        })
        
        assert response.status_code == 422  # Validation error
        
    def test_invalid_language(self):
        """–¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —è–∑—ã–∫–∞"""
        response = client.post("/generate_story", json={
            "age": 5,
            "language": "en",  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —è–∑—ã–∫
            "characters": ["–ó–∞—è—Ü"]
        })
        
        assert response.status_code == 422
    
    def test_empty_characters(self):
        """–¢–µ—Å—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π"""
        response = client.post("/generate_story", json={
            "age": 5,
            "language": "ru",
            "characters": []
        })
        
        assert response.status_code == 422
    
    def test_duplicate_characters(self):
        """–¢–µ—Å—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π"""
        response = client.post("/generate_story", json={
            "age": 5,
            "language": "ru",
            "characters": ["–ó–∞—è—Ü", "–ó–∞—è—Ü"]  # –î—É–±–ª–∏–∫–∞—Ç
        })
        
        assert response.status_code == 422

class TestHealthCheck:
    """–¢–µ—Å—Ç—ã health check —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞"""
    
    def test_health_endpoint(self):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞"""
        response = client.get("/health")
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "healthy"
        assert "service" in data

class TestStoryRequestModel:
    """–¢–µ—Å—Ç—ã –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö"""
    
    def test_valid_story_request(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–∞"""
        request = StoryRequest(
            age=6,
            language="ru",
            characters=["–ó–∞—è—Ü", "–í–æ–ª–∫"]
        )
        
        assert request.age == 6
        assert request.language == "ru"
        assert len(request.characters) == 2
    
    def test_character_validation(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π"""
        # –¢–µ—Å—Ç —Å –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
        request = StoryRequest(
            age=5,
            language="ru",
            characters=["–ó–∞—è—Ü", "", "  ", "–í–æ–ª–∫"]
        )
        
        # –î–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
        assert len(request.characters) == 2
        assert "–ó–∞—è—Ü" in request.characters
        assert "–í–æ–ª–∫" in request.characters

class TestStoryGeneratorService:
    """–¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
    
    @pytest.mark.asyncio
    async def test_prompt_creation(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤"""
        service = StoryGeneratorService()
        
        # –¢–µ—Å—Ç —Ä—É—Å—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        ru_prompt = service._create_system_prompt(5, "ru")
        assert "5 –ª–µ—Ç" in ru_prompt
        assert "–†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï" in ru_prompt
        
        # –¢–µ—Å—Ç –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        kk_prompt = service._create_system_prompt(7, "kk")
        assert "7 –∂–∞—Å—Ç–∞“ì—ã" in kk_prompt
        assert "“õ–∞–∑–∞“õ—à–∞" in kk_prompt.lower()
    
    def test_user_prompt_creation(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
        service = StoryGeneratorService()
        characters = ["–ó–∞—è—Ü", "–í–æ–ª–∫"]
        
        ru_prompt = service._create_user_prompt(characters, "ru")
        assert "–ó–∞—è—Ü, –í–æ–ª–∫" in ru_prompt
        
        kk_prompt = service._create_user_prompt(characters, "kk")
        assert "–ó–∞—è—Ü, –í–æ–ª–∫" in kk_prompt

class TestStreaming:
    """–¢–µ—Å—Ç—ã –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏"""
    
    def test_streaming_response(self):
        """–¢–µ—Å—Ç –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        response = client.post("/generate_story", json={
            "age": 4,
            "language": "ru",
            "characters": ["–ú–µ–¥–≤–µ–¥—å"]
        }, stream=True)
        
        assert response.status_code == 200
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ —á–∞—Å—Ç—è–º
        content_chunks = []
        for chunk in response.iter_content(chunk_size=1024, decode_unicode=True):
            if chunk:
                content_chunks.append(chunk)
        
        # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –¥–ª—è —Å–∫–∞–∑–∫–∏
        assert len(content_chunks) > 0
        full_content = "".join(content_chunks)
        assert len(full_content) > 100

# –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
@pytest.fixture
def sample_story_data():
    """–§–∏–∫—Å—Ç—É—Ä–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å–∫–∞–∑–∫–∏"""
    return {
        "age": 6,
        "language": "ru",
        "characters": ["–ó–∞—è—Ü", "–í–æ–ª–∫", "–õ–∏—Å–∞"]
    }

@pytest.fixture
def invalid_story_data():
    """–§–∏–∫—Å—Ç—É—Ä–∞ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    return {
        "age": 25,
        "language": "en",
        "characters": []
    }

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
class TestIntegration:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã"""
    
    def test_full_generation_flow(self, sample_story_data):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
        # 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        response = client.post("/generate_story", json=sample_story_data)
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
        assert response.status_code == 200
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        content = response.content.decode('utf-8')
        assert len(content) > 200  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–∫–∞–∑–∫–∏
        
        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        for character in sample_story_data["characters"]:
            assert character in content
    
    def test_error_handling(self, invalid_story_data):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
        response = client.post("/generate_story", json=invalid_story_data)
        
        assert response.status_code == 422
        error_data = response.json()
        assert "detail" in error_data

# Performance —Ç–µ—Å—Ç—ã
class TestPerformance:
    """–¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    
    def test_response_time(self, sample_story_data):
        """–¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞"""
        import time
        
        start_time = time.time()
        response = client.post("/generate_story", json=sample_story_data)
        end_time = time.time()
        
        response_time = end_time - start_time
        
        # –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º (–¥–∞–∂–µ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π)
        assert response_time < 30  # 30 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
        assert response.status_code == 200

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
if __name__ == "__main__":
    pytest.main([__file__, "-v", "--tb=short"])
```

### –¢–µ—Å—Ç—ã Yii2

#### `tests/functional/StoryCest.php` - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php

class StoryCest
{
    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏
     */
    public function testCreateStory(FunctionalTester $I)
    {
        $I->amOnPage('/story');
        $I->see('–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ª—à–µ–±–Ω–æ–π —Å–∫–∞–∑–∫–∏');
        $I->seeElement('form#story-form');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
        $I->selectOption('#storyform-age', '6');
        $I->checkOption('#lang-ru');
        $I->checkOption('input[value="–ó–∞—è—Ü"]');
        $I->checkOption('input[value="–í–æ–ª–∫"]');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        $I->click('–°–æ–∑–¥–∞—Ç—å –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É');
        $I->seeInCurrentUrl('/story/stream');
        $I->see('–í–æ–ª—à–µ–±–Ω–∞—è —Å–∫–∞–∑–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è');
    }
    
    /**
     * –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
     */
    public function testFormValidation(FunctionalTester $I)
    {
        $I->amOnPage('/story');
        
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é —Ñ–æ—Ä–º—É
        $I->click('–°–æ–∑–¥–∞—Ç—å –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É');
        $I->see('Age cannot be blank');
        $I->see('Language cannot be blank');
        $I->see('Characters cannot be blank');
    }
    
    /**
     * –¢–µ—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–∞–∑–æ–∫
     */
    public function testStoryHistory(FunctionalTester $I)
    {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å–∫–∞–∑–∫—É
        $story = new \app\modules\story\models\Story();
        $story->age = 5;
        $story->language = 'ru';
        $story->setCharactersArray(['–ó–∞—è—Ü', '–í–æ–ª–∫']);
        $story->content = '–ñ–∏–ª–∞-–±—ã–ª —Å–∫–∞–∑–∫–∞...';
        $story->save();
        
        $I->amOnPage('/story/history');
        $I->see('–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–∑–æ–∫');
        $I->see('–ñ–∏–ª–∞-–±—ã–ª —Å–∫–∞–∑–∫–∞...');
    }
    
    /**
     * –¢–µ—Å—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–∫–∞–∑–∫–∏
     */
    public function testViewStory(FunctionalTester $I)
    {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å–∫–∞–∑–∫—É
        $story = new \app\modules\story\models\Story();
        $story->age = 7;
        $story->language = 'ru';
        $story->setCharactersArray(['–ú–µ–¥–≤–µ–¥—å']);
        $story->content = '–í –ª–µ—Å—É –∂–∏–ª –º–µ–¥–≤–µ–¥—å...';
        $story->save();
        
        $I->amOnPage("/story/view/{$story->id}");
        $I->see('–í –ª–µ—Å—É –∂–∏–ª –º–µ–¥–≤–µ–¥—å...');
        $I->see('7 –ª–µ—Ç');
        $I->see('–ú–µ–¥–≤–µ–¥—å');
    }
}
```

#### `tests/unit/StoryTest.php` - Unit —Ç–µ—Å—Ç—ã –º–æ–¥–µ–ª–µ–π

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```php
<?php

class StoryTest extends \Codeception\Test\Unit
{
    /**
     * –¢–µ—Å—Ç –º–æ–¥–µ–ª–∏ Story
     */
    public function testStoryModel()
    {
        $story = new \app\modules\story\models\Story();
        
        // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        $story->age = 5;
        $story->language = 'ru';
        $story->setCharactersArray(['–ó–∞—è—Ü', '–í–æ–ª–∫']);
        $story->content = '–¢–µ—Å—Ç–æ–≤–∞—è —Å–∫–∞–∑–∫–∞';
        
        $this->assertTrue($story->validate());
        
        // –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        $this->assertTrue($story->save());
        $this->assertNotNull($story->id);
        
        // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        $characters = $story->getCharactersArray();
        $this->assertCount(2, $characters);
        $this->assertContains('–ó–∞—è—Ü', $characters);
        $this->assertContains('–í–æ–ª–∫', $characters);
        
        // –¢–µ—Å—Ç –ø—Ä–µ–≤—å—é
        $preview = $story->getPreview(10);
        $this->assertEquals('–¢–µ—Å—Ç–æ–≤–∞—è —Å...', $preview);
    }
    
    /**
     * –¢–µ—Å—Ç —Ñ–æ—Ä–º—ã StoryForm
     */
    public function testStoryForm()
    {
        $form = new \app\modules\story\models\StoryForm();
        
        // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        $form->age = 6;
        $form->language = 'ru';
        $form->characters = ['–ó–∞—è—Ü', '–í–æ–ª–∫', '–õ–∏—Å–∞'];
        
        $this->assertTrue($form->validate());
        
        // –¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        $form->age = 25; // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç
        $this->assertFalse($form->validate());
        
        // –¢–µ—Å—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ API –¥–∞–Ω–Ω—ã–µ
        $apiData = $form->toApiData();
        $this->assertEquals(6, $apiData['age']);
        $this->assertEquals('ru', $apiData['language']);
        $this->assertCount(3, $apiData['characters']);
    }
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- üß™ **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ** - unit, functional, integration —Ç–µ—Å—Ç—ã
- üîÑ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ streaming —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- üìä **Performance —Ç–µ—Å—Ç—ã** - –∏–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- üõ°Ô∏è **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- üéØ **–§–∏–∫—Å—Ç—É—Ä—ã** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- üìù **–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

---

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

#### 1. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

```yaml
# Docker Compose scale
services:
  story-api:
    deploy:
      replicas: 3  # 3 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ Python API
```

#### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```php
// Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–∫–∞–∑–æ–∫
'cache' => [
    'class' => 'yii\redis\Cache',
    'redis' => [
        'hostname' => 'redis',
        'port' => 6379,
    ],
],
```

#### 3. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- üéôÔ∏è **–ì–æ–ª–æ—Å–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ** - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –¥–ª—è —Å–∫–∞–∑–æ–∫
- üé® **–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ DALL-E
- üë• **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- üì± **–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - React Native –≤–µ—Ä—Å–∏—è

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞

### üèÜ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏

1. **Real-time streaming** - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
2. **–î–≤—É—è–∑—ã—á–Ω–æ—Å—Ç—å** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ
3. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### üí° –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

1. **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –ø–æ–Ω—è—Ç–Ω—ã–π –¥–∞–∂–µ –¥–ª—è –¥–µ—Ç–µ–π
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
3. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏—è

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ

1. **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫** - –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –∏ –∑–∞–ø—Ä–æ—Å—ã
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø–æ–ª–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∫–∞–∑–æ–∫" –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–µ –ø–µ—Ä–µ–¥–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞. 

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- ‚úÖ **–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –≤ production-ready —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- ‚úÖ **–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π real-time –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** —Å streaming –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- ‚úÖ **–ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –Ω–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- ‚úÖ **–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
- ‚úÖ **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI/UX** —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI GPT-4o-mini** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ:**
- üèóÔ∏è **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- üîÑ **Real-time streaming** —á–µ—Ä–µ–∑ Server-Sent Events
- üõ°Ô∏è **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** –∏ –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- üìä **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- üê≥ **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- üß™ **–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã** –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
- üìù **–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏—è

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- üé® **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –ø–æ–Ω—è—Ç–Ω—ã–π –¥–∞–∂–µ –¥–µ—Ç—è–º
- üì± **Responsive –¥–∏–∑–∞–π–Ω** –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚ö° **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- üåç **–î–≤—É—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** —Å –∫—É–ª—å—Ç—É—Ä–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π
- üé≠ **–ë–æ–≥–∞—Ç—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π** –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä
- üìñ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏** —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–∞–∑–æ–∫
- üó£Ô∏è **–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ** —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç. –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ª–µ–≥–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã.
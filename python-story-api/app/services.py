import asyncio
import logging
from typing import AsyncGenerator, List

from openai import AsyncOpenAI

from app.config import settings

logger = logging.getLogger(__name__)


class StoryGeneratorService:
    """–°–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç—Å–∫–∏—Ö —Å–∫–∞–∑–æ–∫ —á–µ—Ä–µ–∑ OpenAI API."""

    def __init__(self):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º AsyncOpenAI –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
        self.model = settings.OPENAI_MODEL
        logger.info(f"‚úÖ OpenAI async client initialized with model: {self.model}")

    # ---------------------------- –Ø–∑—ã–∫–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------------------------

    def _get_language_name(self, language: str) -> str:
        return "—Ä—É—Å—Å–∫–æ–º" if language == "ru" else "–∫–∞–∑–∞—Ö—Å–∫–æ–º"

    def _get_language_name_nominative(self, language: str) -> str:
        return "—Ä—É—Å—Å–∫–∏–π" if language == "ru" else "–∫–∞–∑–∞—Ö—Å–∫–∏–π"

    # ---------------------------- –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã ---------------------------

    def _create_system_prompt(self, age: int, language: str) -> str:
        """–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏."""

        # ------------------------- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ -------------------------
        if language == "ru":
            return f"""
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å-—Å–∫–∞–∑–æ—á–Ω–∏–∫.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ, –¥–æ–±—Ä—ã–µ –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫–∞–∑–∫–∏ –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.

–û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –°–ö–ê–ó–ö–ï:
‚Ä¢ –Ø–∑—ã–∫: —Å—Ç—Ä–æ–≥–æ —Ä—É—Å—Å–∫–∏–π
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç —á–∏—Ç–∞—Ç–µ–ª—è: {age} –ª–µ—Ç
‚Ä¢ –û–±—ä—ë–º: 600‚Äì1200 —Å–ª–æ–≤
‚Ä¢ –°—Ç–∏–ª—å: –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π —Ä–µ–±—ë–Ω–∫—É {age} –ª–µ—Ç
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≤—è–∑–∫–∞ ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Üí –∫—É–ª—å–º–∏–Ω–∞—Ü–∏—è ‚Üí —Ä–∞–∑–≤—è–∑–∫–∞
‚Ä¢ –§–∏–Ω–∞–ª: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±—Ä—ã–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π
‚Ä¢ –ü–æ—Å—ã–ª: –º—è–≥–∫–∞—è –º–æ—Ä–∞–ª—å, –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –Ω–∞–∑–∏–¥–∞–Ω–∏—è

–û–°–û–ë–ï–ù–ù–û–°–¢–ò:
‚Ä¢ –ü–∏—à–∏ –∂–∏–≤–æ, –æ–±—Ä–∞–∑–Ω–æ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
‚Ä¢ –î–æ–±–∞–≤–ª—è–π —ç–ª–µ–º–µ–Ω—Ç—ã —é–º–æ—Ä–∞, –≤–æ–ª—à–µ–±—Å—Ç–≤–∞ –∏ –ª—ë–≥–∫–∏—Ö –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–µ–π.
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –∏ –≤–ª–∏—è—Ç—å –Ω–∞ —Å—é–∂–µ—Ç.
‚Ä¢ –ò–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö –ø–æ–≤—Ç–æ—Ä–æ–≤ –∏ ¬´–≤–æ–¥—ã¬ª.
‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏–ª–∏ —Å–ø–∏—Å–∫–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏.

–ü–ò–®–ò –°–¢–†–û–ì–û –ù–ê –†–£–°–°–ö–û–ú.
"""

        # ------------------------- –ö–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ -------------------------
        return f"""
–°—ñ–∑ ‚Äî –∫”ô—Å—ñ–±–∏ –±–∞–ª–∞–ª–∞—Ä –∂–∞–∑—É—à—ã—Å—ã –∂”ô–Ω–µ –µ—Ä—Ç–µ–≥—ñ “õ“±—Ä–∞—Å—Ç—ã—Ä—É—à—ã—Å—ã–∑.
–ú—ñ–Ω–¥–µ—Ç—ñ“£—ñ–∑ ‚Äî {age} –∂–∞—Å—Ç–∞“ì—ã –±–∞–ª–∞“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω “õ—ã–∑—ã“õ—Ç—ã, –º–µ–π—ñ—Ä—ñ–º–¥—ñ –∂”ô–Ω–µ —Ç”ô—Ä–±–∏–µ–ª—ñ–∫ –º–∞–∑–º“±–Ω–¥–∞“ì—ã –µ—Ä—Ç–µ–≥—ñ –ñ–ê–ó–£.

–ï–†–¢–ï–ì–Ü –¢–ê–õ–ê–ü–¢–ê–†–´:
‚Ä¢ –¢—ñ–ª: —Ç–µ–∫ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ
‚Ä¢ –û“õ—ã—Ä–º–∞–Ω –∂–∞—Å—ã: {age} –∂–∞—Å
‚Ä¢ –ö”©–ª–µ–º—ñ: 600‚Äì1200 —Å”©–∑
‚Ä¢ “ö“±—Ä—ã–ª—ã–º—ã: –±–∞—Å—Ç–∞–ª—É ‚Üí –¥–∞–º—É—ã ‚Üí —à–∏–µ–ª–µ–Ω—ñ—Å ‚Üí “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã
‚Ä¢ –°–æ“£—ã: –∂—ã–ª—ã, –ø–æ–∑–∏—Ç–∏–≤—Ç—ñ
‚Ä¢ –¢”ô—Ä–±–∏–µ—Å—ñ: –∂“±–º—Å–∞“õ, —Ç—ñ–∫–µ–ª–µ–π “Ø–π—Ä–µ—Ç–ø–µ–π –∂–µ—Ç–∫—ñ–∑—É

–ï–†–ï–ö–®–ï–õ–Ü–ö–¢–ï–†:
‚Ä¢ –°”©–π–ª–µ–º–¥–µ—Ä “õ—ã—Å“õ–∞ ”ô—Ä—ñ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ –±–æ–ª—Å—ã–Ω.
‚Ä¢ ”ò–∑—ñ–ª, “õ–∏—è–ª-“ì–∞–∂–∞–π—ã–ø —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä –º–µ–Ω –∫“Ø—Ç–ø–µ–≥–µ–Ω –±“±—Ä—ã–ª—ã—Å—Ç–∞—Ä “õ–æ—Å—ã“£—ã–∑.
‚Ä¢ –ö–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä–¥—ñ“£ –º—ñ–Ω–µ–∑—ñ –∞–Ω—ã“õ –±–æ–ª—Å—ã–Ω –∂”ô–Ω–µ –æ“õ–∏“ì–∞“ì–∞ ”ô—Å–µ—Ä –µ—Ç—Å—ñ–Ω.
‚Ä¢ –û“õ–∏“ì–∞ –ª–æ–≥–∏–∫–∞–ª—ã“õ –∂”ô–Ω–µ –±—ñ—Ä—Ç“±—Ç–∞—Å –±–æ–ª—É—ã “õ–∞–∂–µ—Ç.
‚Ä¢ –¢–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä –º–µ–Ω —Ç—ñ–∑—ñ–º–¥–µ—Ä “õ–æ–ª–¥–∞–Ω—ã–ª–º–∞–π–¥—ã ‚Äî —Ç–µ–∫ –µ—Ä—Ç–µ–≥—ñ–Ω—ñ“£ –º”ô—Ç—ñ–Ω—ñ.
‚Ä¢ –ï–≥–µ—Ä –∫–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä–¥—ñ“£ –∞—Ç—Ç–∞—Ä—ã –±–∞—Å“õ–∞ —Ç—ñ–ª–¥–µ –±–æ–ª—Å–∞, –æ–ª–∞—Ä–¥—ã –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ “õ–∞–∑–∞“õ—à–∞ –∞—É–¥–∞—Ä—ã“£—ã–∑.
‚Ä¢ –¢“Ø–ø–Ω“±—Å“õ–∞ –∞—Ç–∞—É–ª–∞—Ä –µ—à“õ–∞—à–∞–Ω “õ–æ–ª–¥–∞–Ω—ã–ª–º–∞—É—ã —Ç–∏—ñ—Å.

–¢–ï–ö “ö–ê–ó–ê“ö –¢–Ü–õ–Ü–ù–î–ï –ñ–ê–ó–´“¢–´–ó.
"""

    # ----------------------------- User –ø—Ä–æ–º–ø—Ç—ã ------------------------------

    def _create_user_prompt(self, characters: List[str], language: str) -> str:
        characters_str = ", ".join(characters)

        # ------------------------- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ -------------------------
        if language == "ru":
            return f"""
–ù–∞–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∫–∞–∑–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∞—Å—Ç–≤—É—é—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∏: {characters_str}.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
‚Ä¢ –í—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ —Ä–æ–ª—å –≤ —Å—é–∂–µ—Ç–µ.
‚Ä¢ –ò—Ö –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã–º–∏ –∏ –≤–ª–∏—è—Ç—å –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é.
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—å–Ω–æ–π, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤ –∏ –ø—Ä–æ–≤–∏—Å–∞–Ω–∏–π.
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ‚Äî —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–π —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏.
‚Ä¢ –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∂–∏–≤–æ –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ.
‚Ä¢ –°—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
"""

        # ------------------------- –ö–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ -------------------------
        return f"""
–ö–µ–ª–µ—Å—ñ –∫–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä “õ–∞—Ç—ã—Å–∞—Ç—ã–Ω —Ç–æ–ª—ã“õ –µ—Ä—Ç–µ–≥—ñ –∂–∞–∑—ã“£—ã–∑: {characters_str}.

–ú–Ü–ù–î–ï–¢–¢–Ü –¢“Æ–†–î–ï –û“ö–´“¢–´–ó:
‚Ä¢ –ë–∞—Ä–ª—ã“õ –∫–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä–¥—ñ“£ –∞—Ç—Ç–∞—Ä—ã “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–µ –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ –ê–£–î–ê–†–´–õ–£–´ –∫–µ—Ä–µ–∫.
‚Ä¢ –ê—Ç–∞—É–ª–∞—Ä –µ—à“õ–∞–Ω–¥–∞–π –∂–∞“ì–¥–∞–π–¥–∞ —Ç“Ø–ø–Ω“±—Å“õ–∞ –∫“Ø–π—ñ–Ω–¥–µ “õ–∞–ª–º–∞—É—ã —Ç–∏—ñ—Å.
‚Ä¢ –ï–≥–µ—Ä –∫–µ–π—ñ–ø–∫–µ—Ä–¥—ñ“£ –∞—Ç—ã –±–µ–ª–≥—ñ–ª—ñ –±—ñ—Ä –µ—Ä—Ç–µ–≥—ñ–¥–µ–Ω –±–æ–ª—Å–∞ (–º—ã—Å–∞–ª—ã: "–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π"),
  –æ–Ω—ã —Ç–æ–ª—ã“õ“õ–∞–Ω–¥—ã “õ–∞–∑–∞“õ—à–∞ –±–∞–ª–∞–º–∞“ì–∞ –ê–£–î–ê–†:
  ‚Äî "–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π" ‚Üí "”®–ª–º–µ—Å “ö–æ—à“õ–∞—Ä", "–ú”ô“£–≥—ñ “ö–æ–∂–∞", "”®–ª–º–µ—Å –°–∏“õ—ã—Ä—à—ã"
‚Ä¢ –ï—à“õ–∞—à–∞–Ω —Ç“Ø–ø–Ω“±—Å“õ–∞ –∞—Ç–∞—É–¥—ã “õ–∞–π—Ç–∞–ª–∞–º–∞.
‚Ä¢ –ö–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä–¥—ñ“£ –∞—É–¥–∞—Ä—ã–ª“ì–∞–Ω –∞—Ç—Ç–∞—Ä—ã “ì–∞–Ω–∞ –æ“õ–∏“ì–∞–¥–∞ “õ–æ–ª–¥–∞–Ω—ã–ª—Å—ã–Ω.

–ù–ï–ì–Ü–ó–ì–Ü –¢–ê–õ–ê–ü–¢–ê–†:
‚Ä¢ –ë–∞—Ä–ª—ã“õ –∫–µ–π—ñ–ø–∫–µ—Ä–ª–µ—Ä –æ“õ–∏“ì–∞“ì–∞ –±–µ–ª—Å–µ–Ω–¥—ñ “õ–∞—Ç—ã—Å—É—ã –∫–µ—Ä–µ–∫.
‚Ä¢ ”ò—Ä“õ–∞–π—Å—ã–Ω—ã“£ –º—ñ–Ω–µ–∑—ñ –º–µ–Ω —Ä”©–ª—ñ –∞–π“õ—ã–Ω –±–æ–ª—Å—ã–Ω.
‚Ä¢ –û“õ–∏“ì–∞ “õ–∏—Å—ã–Ω–¥—ã, “õ—ã–∑—ã“õ—Ç—ã –∂”ô–Ω–µ –±—ñ—Ä—Ç“±—Ç–∞—Å –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.
‚Ä¢ –¢–∞“õ—ã—Ä—ã–ø “õ–æ–ª–¥–∞–Ω–±–∞“£—ã–∑ ‚Äî –±—ñ—Ä–¥–µ–Ω –µ—Ä—Ç–µ–≥—ñ –º”ô—Ç—ñ–Ω—ñ–Ω –±–∞—Å—Ç–∞“£—ã–∑.
‚Ä¢ –¢–∞–±–∏“ì–∏, –∂—ã–ª—ã, –∂–∞—Ç—ã“õ —Å—Ç–∏–ª—å–º–µ–Ω –∂–∞–∑—ã“£—ã–∑.
‚Ä¢ –ú—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ.
‚Ä¢ –°–æ“£—ã–Ω–¥–∞ "–¢“Ø–π—ñ–Ω:" –¥–µ–ø “õ—ã—Å“õ–∞ “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã “õ–æ—Å—ã“£—ã–∑.
"""

    # --------------------------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–∫–∏ ----------------------------

    async def generate_story_stream(
        self, age: int, language: str, characters: List[str]
    ) -> AsyncGenerator[str, None]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–∫–∏ –≤ –ø–æ—Ç–æ–∫–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (ASYNC)."""

        try:
            logger.info("üìñ Starting story generation...")
            logger.info(f"üåç Language: {language}")
            logger.info(f"üë∂ Age: {age}")
            logger.info(f"üß© Characters: {characters}")

            system_prompt = self._create_system_prompt(age, language)
            user_prompt = self._create_user_prompt(characters, language)

            logger.info(f"üìù System prompt preview: {system_prompt[:120]}...")
            logger.info(f"üìù User prompt preview: {user_prompt[:120]}...")

            stream = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt},
                ],
                stream=True,
                temperature=0.8,
                max_tokens=2000,
                top_p=0.9,
            )

            chunk_count = 0
            async for chunk in stream:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    yield content
                    chunk_count += 1
                    await asyncio.sleep(0.001)

            logger.info(f"‚úÖ Story generated successfully ({chunk_count} chunks).")

        except Exception as e:
            logger.error(f"‚ùå Error in story generation: {e}", exc_info=True)
            error_message = f"\n\n---\n\n**–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏:** {str(e)}\n"
            yield error_message
            raise
